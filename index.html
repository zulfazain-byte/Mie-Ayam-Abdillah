<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Kasir Mie Ayam Abdillah - Pro</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçú</text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0ea5e9">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .category-tab.active-tab {
            background-color: #0ea5e9; color: white;
            box-shadow: 0 4px 14px 0 rgb(14 165 233 / 39%);
        }
        .active-order-type {
            background-color: #0c4a6e; color: white; font-weight: 700;
        }
        .item-out-of-stock { position: relative; cursor: not-allowed; }
        .item-out-of-stock .overlay {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background-color: rgba(255,255,255,0.6);
            display: flex; align-items: center; justify-content: center;
            border-radius: 1rem;
        }
        .dark .item-out-of-stock .overlay { background-color: rgba(30,41,59,0.7); }
        .item-out-of-stock .overlay-text {
            background-color: rgba(15,23,42,0.8); color: white;
            padding: 8px 16px; border-radius: 9999px; font-weight: bold; font-size: 14px;
        }
        .modal-backdrop { backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0.95) translateY(10px); opacity: 0;
        }
        .modal-backdrop.show { opacity: 1; }
        .modal-backdrop.show .modal-content { transform: scale(1) translateY(0); opacity: 1; }

        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; align-items: center; }
        .toast { background-color: #0f172a; color: white; padding: 12px 20px; border-radius: 9999px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 10px; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background-color: #ef4444; }
        .toast.success { background-color: #22c55e; }

        .settings-tab { border-bottom: 2px solid transparent; }
        .settings-tab.active { border-bottom-color: #0ea5e9; color: #0ea5e9; }

        @media print {
            body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; }
            @page receipt { size: 80mm auto; margin: 0; }
            @page report { size: A4 portrait; margin: 0; }
            #receipt-print-area { page: receipt; }
            #eod-report-print-area { page: report; }
            #shift-report-print-area { page: report; }
        }

        /* Skeleton loading */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; }
        .dark .skeleton { background: linear-gradient(90deg, #2d3748 25%, #4a5568 50%, #2d3748 75%); background-size: 200% 100%; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* ========== PERBAIKAN RESPONSIF ========== */
        /* Base mobile-first */
        .flex-col.lg\:flex-row {
            flex-direction: column;
        }
        .w-full.lg\:w-3\/5, .w-full.lg\:w-2\/5 {
            width: 100%;
        }
        .h-screen {
            height: auto;
            min-height: 100vh;
        }
        /* Grid menu: 2 kolom di mobile, 3 di tablet, 4 di desktop */
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        @media (min-width: 640px) {
            .grid-cols-2 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        @media (min-width: 1024px) {
            .flex-col.lg\:flex-row {
                flex-direction: row;
            }
            .w-full.lg\:w-3\/5 {
                width: 60%;
            }
            .w-full.lg\:w-2\/5 {
                width: 40%;
            }
            .h-screen {
                height: 100vh;
            }
            .grid-cols-2 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        /* Penyesuaian padding dan margin untuk mobile */
        .p-4 {
            padding: 1rem;
        }
        .sm\:p-6 {
            padding: 1.5rem;
        }
        /* Tombol header agar tidak tumpuk */
        .space-x-2 > :not([hidden]) ~ :not([hidden]) {
            margin-left: 0.5rem;
        }
        /* Pastikan konten tidak overflow */
        .overflow-hidden {
            overflow: hidden;
        }
        .overflow-y-auto {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Ukuran font di mobile */
        .text-sm {
            font-size: 0.875rem;
        }
        /* Tombol aksi lebih besar di mobile */
        .py-3\.5 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        /* Modal di mobile */
        @media (max-width: 640px) {
            .modal-content {
                max-width: 95% !important;
                padding: 1rem !important;
            }
            #scanner {
                max-width: 90% !important;
            }
            /* Atur ulang grid di modal split bill */
            .grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            /* Perkecil teks judul */
            .text-2xl {
                font-size: 1.5rem;
            }
            .text-3xl {
                font-size: 2rem;
            }
        }

        /* Memperbaiki tampilan item di keranjang */
        #order-list .flex.items-center {
            flex-wrap: wrap;
        }
        #order-list .flex.items-center .flex-grow {
            min-width: 120px;
        }
        #order-list .flex.items-center .space-x-2 {
            margin-top: 0.5rem;
            justify-content: flex-end;
            width: 100%;
        }
        @media (min-width: 480px) {
            #order-list .flex.items-center .space-x-2 {
                width: auto;
                margin-top: 0;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 antialiased">

    <!-- Shift Start Overlay -->
    <div id="shift-modal" class="fixed inset-0 bg-slate-900 bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-[60] p-4 hidden">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-sm shadow-2xl text-center">
            <h3 class="text-2xl font-bold mb-4 text-slate-900 dark:text-white">Mulai Shift Baru</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-6">Masukkan jumlah modal awal tunai di laci kasir.</p>
            <div class="mb-6">
                <label for="start-cash-input" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Modal Awal (Rp)</label>
                <input type="number" id="start-cash-input" class="w-full text-center bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 text-2xl font-bold focus:border-sky-500 focus:outline-none transition" placeholder="0">
            </div>
            <button onclick="startShift()" class="w-full bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-3 font-bold transition-colors shadow-lg shadow-sky-500/30">Mulai Bekerja</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Main Container -->
    <div id="main-container" class="flex flex-col lg:flex-row h-screen opacity-20 pointer-events-none overflow-hidden">
        <!-- Left Panel: Menu & Categories -->
        <div class="w-full lg:w-3/5 p-4 sm:p-6 flex flex-col overflow-hidden">
            <header class="mb-6 flex justify-between items-center flex-wrap gap-2">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-amber-100 dark:bg-amber-900/50 rounded-2xl flex items-center justify-center text-3xl shadow-md">üçú</div>
                    <div>
                        <h1 id="header-store-name" class="text-3xl sm:text-4xl font-extrabold text-slate-900 dark:text-white">Mie Ayam Abdillah</h1>
                        <p class="text-slate-500 dark:text-slate-400 mt-1 text-sm sm:text-base">Pilih menu untuk ditambahkan ke pesanan.</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 flex-wrap">
                    <button onclick="showActiveOrdersModal()" class="relative p-3 bg-white dark:bg-slate-800 rounded-full shadow-md hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Pesanan Aktif">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        <span id="active-orders-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <button id="dark-mode-toggle" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-md hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Ganti Mode">
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden text-slate-600 dark:text-slate-300"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button onclick="showInventoryModal()" id="inventory-btn" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-md hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Manajemen Stok & Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    </button>
                    <button onclick="showSettingsModal()" id="settings-btn" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-md hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Pengaturan">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    <!-- Tombol Scan Barcode -->
                    <button onclick="toggleScanner()" class="p-3 bg-white dark:bg-slate-800 rounded-full shadow-md hover:bg-slate-100 dark:hover:bg-slate-700 transition" title="Scan Barcode">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><path d="M21 16v2a2 2 0 0 1-2 2h-5"/><path d="M3 16v2a2 2 0 0 0 2 2h5"/><path d="M21 8V6a2 2 0 0 0-2-2h-5"/><path d="M3 8V6a2 2 0 0 1 2-2h5"/><rect x="7" y="12" width="3" height="8"/><rect x="14" y="12" width="3" height="8"/></svg>
                    </button>
                </div>
            </header>
            
            <div class="relative mb-4">
                <input type="text" id="search-bar" class="w-full bg-white dark:bg-slate-800 rounded-full p-3 pl-12 pr-10 text-slate-800 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 border-2 border-slate-200 dark:border-slate-700 focus:border-sky-500 focus:outline-none focus:ring-0 transition" placeholder="Cari menu...">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <button id="search-clear-btn" class="absolute right-4 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition hidden">&times;</button>
            </div>
            
            <div class="flex space-x-2 sm:space-x-3 mb-6 p-1.5 bg-slate-200/80 dark:bg-slate-800 rounded-full text-sm sm:text-base overflow-x-auto">
                <button onclick="filterMenu('semua')" class="category-tab w-full py-2 px-3 rounded-full text-slate-600 dark:text-slate-300 font-semibold transition-all duration-300 whitespace-nowrap">Semua</button>
                <button onclick="filterMenu('mie')" class="category-tab w-full py-2 px-3 rounded-full text-slate-600 dark:text-slate-300 font-semibold transition-all duration-300 whitespace-nowrap">Mie</button>
                <button onclick="filterMenu('topping')" class="category-tab w-full py-2 px-3 rounded-full text-slate-600 dark:text-slate-300 font-semibold transition-all duration-300 whitespace-nowrap">Topping</button>
                <button onclick="filterMenu('minuman')" class="category-tab w-full py-2 px-3 rounded-full text-slate-600 dark:text-slate-300 font-semibold transition-all duration-300 whitespace-nowrap">Minuman</button>
            </div>

            <!-- Skeleton loader for menu -->
            <div id="menu-skeleton" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-5 hidden">
                <div class="skeleton h-48"></div><div class="skeleton h-48"></div><div class="skeleton h-48"></div><div class="skeleton h-48"></div>
                <div class="skeleton h-48"></div><div class="skeleton h-48"></div><div class="skeleton h-48"></div><div class="skeleton h-48"></div>
            </div>
            <div id="menu-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-5 overflow-y-auto flex-grow pr-3"></div>
        </div>

        <!-- Right Panel: Cart -->
        <div class="w-full lg:w-2/5 bg-white dark:bg-slate-800/50 p-4 sm:p-6 flex flex-col shadow-2xl shadow-slate-300/50 dark:shadow-black/50 overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Pesanan Saat Ini</h2>
                 <div id="table-display" class="hidden font-bold text-lg bg-amber-100 text-amber-800 px-4 py-1.5 rounded-lg">
                     Meja: <span id="table-number-display"></span>
                 </div>
            </div>
            
            <div class="grid grid-cols-1 gap-4 mb-4 overflow-y-auto">
                 <div>
                     <label class="block text-slate-500 dark:text-slate-400 mb-2 text-sm font-semibold">Tipe Pesanan</label>
                     <div class="grid grid-cols-3 gap-2 bg-slate-100 dark:bg-slate-900 p-1 rounded-lg">
                         <button id="order-type-dine-in" onclick="setOrderType('Dine-In')" class="order-type-btn rounded-md py-2 text-sm font-semibold transition-colors">Dine-In</button>
                         <button id="order-type-take-away" onclick="setOrderType('Take Away')" class="order-type-btn rounded-md py-2 text-sm font-semibold transition-colors">Take Away</button>
                         <button id="order-type-online" onclick="setOrderType('Online')" class="order-type-btn rounded-md py-2 text-sm font-semibold transition-colors">Online</button>
                     </div>
                 </div>
                 <div id="table-management-section">
                     <label class="block text-slate-500 dark:text-slate-400 mb-2 text-sm font-semibold">Manajemen Meja</label>
                     <button onclick="showTableModal()" class="w-full bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white rounded-lg p-2.5 font-semibold transition-colors">Pilih Meja</button>
                 </div>
                 <div>
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 text-sm font-semibold">Tipe Pelanggan</label>
                    <div class="grid grid-cols-2 gap-2 bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-2">
                        <button id="customer-type-guest" onclick="setCustomerType('guest')" class="customer-type-btn rounded-md py-2 text-sm font-semibold transition-colors">Tamu Biasa</button>
                        <button id="customer-type-member" onclick="setCustomerType('member')" class="customer-type-btn rounded-md py-2 text-sm font-semibold transition-colors">Member</button>
                    </div>
                    <div id="customer-selection-area" class="hidden">
                        <div id="customer-display-section" class="flex items-center space-x-2">
                            <div id="customer-display" class="flex-grow bg-slate-100 dark:bg-slate-900 rounded-lg p-2.5 text-slate-800 dark:text-slate-200 cursor-pointer" onclick="showCustomerModal()">
                                <span id="customer-name-display" class="font-semibold text-slate-500 dark:text-slate-400">Pilih Member...</span>
                            </div>
                            <button id="clear-customer-btn" onclick="clearSelectedCustomer()" class="hidden bg-red-500 hover:bg-red-600 text-white rounded-lg p-2.5 font-semibold transition-colors" title="Hapus Member">&times;</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="order-list" class="flex-grow overflow-y-auto -mr-2 pr-2 min-h-0">
                 <p id="empty-cart-message" class="text-slate-400 dark:text-slate-500 text-center mt-16">Keranjang masih kosong.</p>
            </div>
            
            <div class="border-t-2 border-slate-100 dark:border-slate-700 pt-4 mt-4">
                 <div class="space-y-2 text-md mb-4">
                     <div class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Subtotal</span><span id="subtotal" class="font-semibold">Rp 0</span></div>
                     <div class="flex justify-between items-center">
                         <span class="text-slate-500 dark:text-slate-400">Diskon</span>
                         <div class="flex items-center">
                             <span id="discount-amount" class="font-semibold mr-2 text-green-600 dark:text-green-500">- Rp 0</span>
                             <button onclick="showDiscountModal()" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 text-xs font-bold py-1 px-2 rounded-md transition">Atur</button>
                         </div>
                     </div>
                     <div id="tax-row" class="flex justify-between"><span class="text-slate-500 dark:text-slate-400">Pajak (<span id="tax-rate-display">10</span>%)</span><span id="tax" class="font-semibold">Rp 0</span></div>
                 </div>
                 <div class="flex justify-between text-2xl font-bold text-slate-900 dark:text-white mb-4">
                     <span>Total</span>
                     <span id="total" class="text-sky-600">Rp 0</span>
                 </div>
                
                 <div class="grid grid-cols-3 gap-4">
                     <button onclick="confirmCancelOrder()" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 rounded-xl py-3.5 font-bold transition-colors">Batal</button>
                     <button onclick="holdOrder()" id="hold-button" class="w-full bg-amber-500 hover:bg-amber-600 text-white rounded-xl py-3.5 font-bold transition-colors disabled:bg-slate-300 dark:disabled:bg-slate-600 disabled:cursor-not-allowed">Simpan</button>
                     <button onclick="showPaymentModal()" id="pay-button" class="w-full bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-3.5 font-bold transition-colors shadow-lg shadow-sky-500/30 disabled:bg-slate-300 dark:disabled:bg-slate-600 disabled:shadow-none disabled:cursor-not-allowed" disabled>Bayar</button>
                 </div>
                  <div class="grid grid-cols-2 gap-4 mt-4">
                     <button onclick="showHistoryModal()" class="w-full bg-white border-2 border-slate-200 hover:bg-slate-100 text-slate-800 dark:bg-slate-800 dark:border-slate-600 dark:hover:bg-slate-700 dark:text-slate-200 rounded-xl py-3 font-bold transition-colors">Riwayat</button>
                     <button onclick="showDashboardModal()" class="w-full bg-white border-2 border-slate-200 hover:bg-slate-100 text-slate-800 dark:bg-slate-800 dark:border-slate-600 dark:hover:bg-slate-700 dark:text-slate-200 rounded-xl py-3 font-bold transition-colors">Dashboard</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Video Scanner -->
    <video id="scanner" style="width:100%; max-width:400px; display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1000; border-radius:1rem; border:4px solid #0ea5e9;"></video>

    <!-- ==================== MODALS ==================== -->

    <!-- Split Bill Modal -->
    <div id="split-bill-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-4xl shadow-2xl flex flex-col modal-content" style="height: 90vh;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Pecah Tagihan</h3>
                <button onclick="closeModal('split-bill-modal')" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow overflow-hidden">
                <div id="split-bill-original-items" class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg flex flex-col">
                    <h4 class="font-bold text-lg mb-4">Item Asli (<span id="split-original-count">0</span>)</h4>
                    <div class="flex-grow overflow-y-auto space-y-2 pr-2 -mr-2"></div>
                </div>
                <div id="split-bill-new-bill" class="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg flex flex-col">
                    <h4 class="font-bold text-lg mb-4">Tagihan Baru (<span id="split-new-count">0</span>)</h4>
                    <div class="flex-grow overflow-y-auto space-y-2 pr-2 -mr-2"></div>
                    <div class="border-t dark:border-slate-700 mt-4 pt-4">
                        <div class="flex justify-between font-bold text-xl">
                            <span>Total Tagihan Baru:</span>
                            <span id="split-new-total">Rp 0</span>
                        </div>
                        <button onclick="processSplitBillPayment()" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white rounded-xl py-3 font-bold transition">Bayar Tagihan Ini</button>
                    </div>
                </div>
            </div>
             <div class="mt-6 border-t dark:border-slate-700 pt-4">
                <h4 class="font-bold text-lg mb-2">Bagi Rata</h4>
                <div class="flex items-center space-x-4">
                    <input type="number" id="split-evenly-input" min="2" class="w-24 bg-white dark:bg-slate-700 rounded-lg p-2 border-2 border-slate-200 dark:border-slate-600" placeholder="Jumlah">
                    <button onclick="splitBillEvenly()" class="bg-sky-500 hover:bg-sky-600 text-white rounded-lg py-2 px-4 font-bold transition">Bagi</button>
                    <div id="split-evenly-result" class="font-semibold text-slate-600 dark:text-slate-300"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Orders Modal -->
    <div id="active-orders-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-2xl shadow-2xl flex flex-col modal-content" style="height: 85vh;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Pesanan Aktif</h3>
                <button onclick="closeModal('active-orders-modal')" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
            </div>
            <div id="active-orders-list" class="flex-grow overflow-y-auto pr-2 -mr-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
         <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-sm sm:max-w-md shadow-2xl modal-content">
             <h3 class="text-2xl font-bold mb-6 text-center text-slate-900 dark:text-white">Detail Pembayaran</h3>
             <div>
                 <div class="mb-4">
                     <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Metode Pembayaran</label>
                     <div class="grid grid-cols-3 gap-2 bg-slate-100 dark:bg-slate-900 p-1 rounded-lg">
                         <button onclick="selectPaymentMethod('Tunai', event)" class="payment-method-btn rounded-md py-2 text-sm font-semibold transition-colors active-order-type">Tunai</button>
                         <button onclick="selectPaymentMethod('QRIS', event)" class="payment-method-btn rounded-md py-2 text-sm font-semibold transition-colors">QRIS</button>
                         <button onclick="selectPaymentMethod('Debit', event)" class="payment-method-btn rounded-md py-2 text-sm font-semibold transition-colors">Debit</button>
                     </div>
                 </div>
                 <div class="mb-4">
                     <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Total Tagihan</label>
                     <input type="text" id="total-tagihan" class="w-full bg-slate-100 dark:bg-slate-900 rounded-lg p-3 text-2xl font-bold text-right text-slate-900 dark:text-white" readonly>
                 </div>
                 <div id="cash-payment-section">
                     <div class="mb-4">
                         <label for="uang-diterima" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Uang Diterima</label>
                         <input type="number" id="uang-diterima" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 text-2xl font-bold text-right focus:border-sky-500 focus:outline-none transition" placeholder="0">
                     </div>
                     <div class="mb-4">
                         <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Uang Cepat</label>
                         <div class="grid grid-cols-3 gap-2">
                             <button onclick="setQuickCash(50000)" class="bg-slate-100 dark:bg-slate-700 hover:bg-sky-100 dark:hover:bg-sky-600 text-sky-800 dark:text-sky-200 rounded-lg py-2 font-bold transition">50 rb</button>
                             <button onclick="setQuickCash(100000)" class="bg-slate-100 dark:bg-slate-700 hover:bg-sky-100 dark:hover:bg-sky-600 text-sky-800 dark:text-sky-200 rounded-lg py-2 font-bold transition">100 rb</button>
                             <button onclick="setQuickCash('pas')" class="bg-slate-100 dark:bg-slate-700 hover:bg-sky-100 dark:hover:bg-sky-600 text-sky-800 dark:text-sky-200 rounded-lg py-2 font-bold transition">Pas</button>
                         </div>
                     </div>
                 </div>
                 <!-- Bagian QRIS -->
                 <div id="qris-payment-section" class="hidden mb-4">
                     <label for="qris-code" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Kode QRIS / ID Transaksi</label>
                     <input type="text" id="qris-code" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" placeholder="Masukkan kode atau ID">
                 </div>
                 <!-- Catatan untuk seluruh pesanan -->
                 <div class="mb-4">
                     <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Catatan Pesanan (opsional)</label>
                     <textarea id="order-note" rows="2" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" placeholder="Contoh: Tidak pakai bawang, Pedas ekstra..."></textarea>
                 </div>
             </div>
             <button onclick="showSplitBillModal()" id="split-bill-button" class="w-full mt-2 mb-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl py-3 font-bold transition-colors">Pecah Tagihan</button>
             <div id="change-section" class="flex justify-between items-center text-xl bg-green-50 dark:bg-green-900/50 p-4 rounded-lg mb-6">
                 <span class="font-semibold text-green-800 dark:text-green-300">Kembalian</span>
                 <span id="kembalian" class="font-bold text-green-700 dark:text-green-400">Rp 0</span>
             </div>
             <div class="grid grid-cols-2 gap-4">
                 <button onclick="closeModal('payment-modal')" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 rounded-xl py-3 font-bold transition-colors">Tutup</button>
                 <button onclick="processPayment()" id="confirm-payment-button" class="bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-3 font-bold transition-colors shadow-lg shadow-sky-500/30 disabled:bg-slate-300 dark:disabled:bg-slate-600 disabled:shadow-none" disabled>Konfirmasi Bayar</button>
             </div>
         </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 text-slate-900 dark:text-white rounded-2xl p-6 w-full max-w-sm shadow-2xl modal-content flex flex-col" style="height: 80vh;">
            <h3 class="text-xl font-bold text-center mb-4">Pratinjau Nota</h3>
            <div class="flex-grow overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg p-2 bg-white">
                <div id="receipt-print-area" class="printable-area"></div>
            </div>
            <div class="mt-6 flex justify-between">
                <button onclick="closeModal('receipt-modal')" class="bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 hover:bg-slate-300 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg transition">Tutup</button>
                <button onclick="printReceipt()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">Cetak Nota</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-3xl shadow-2xl flex flex-col modal-content" style="height: 85vh;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Riwayat Transaksi</h3>
                <div class="flex gap-2">
                    <button onclick="exportToCSV()" class="bg-green-500 hover:bg-green-600 text-white rounded-lg py-2 px-4 font-bold transition text-sm">Ekspor CSV</button>
                    <button onclick="closeModal('history-modal')" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
                </div>
            </div>
            <div id="history-list" class="flex-grow overflow-y-auto pr-2 -mr-2"></div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboard-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-6xl shadow-2xl flex flex-col modal-content" style="height: 90vh;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Dashboard Penjualan</h3>
                <div class="flex space-x-2">
                    <select id="dashboard-cashier-filter" class="bg-slate-100 dark:bg-slate-700 rounded-lg px-3 py-1 text-sm">
                        <option value="all">Semua Kasir</option>
                    </select>
                    <div class="flex space-x-2 p-1 bg-slate-100 dark:bg-slate-900 rounded-lg">
                        <button onclick="renderDashboard('today', event)" class="dashboard-range-btn px-3 py-1 rounded-md text-sm font-semibold">Hari Ini</button>
                        <button onclick="renderDashboard('7days', event)" class="dashboard-range-btn px-3 py-1 rounded-md text-sm font-semibold">7 Hari</button>
                        <button onclick="renderDashboard('30days', event)" class="dashboard-range-btn px-3 py-1 rounded-md text-sm font-semibold">30 Hari</button>
                        <button onclick="renderDashboard('custom', event)" class="dashboard-range-btn px-3 py-1 rounded-md text-sm font-semibold">Kustom</button>
                    </div>
                    <button onclick="closeModal('dashboard-modal')" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
                </div>
            </div>
            <div id="dashboard-content" class="flex-grow overflow-y-auto pr-2 -mr-2"></div>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discount-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-sm shadow-2xl modal-content">
            <h3 class="text-2xl font-bold mb-6 text-center text-slate-900 dark:text-white">Atur Diskon</h3>
            <div class="mb-4">
                <label for="discount-type" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Tipe Diskon</label>
                <select id="discount-type" class="w-full bg-slate-100 dark:bg-slate-700 dark:text-white rounded-lg p-3 border-2 border-transparent focus:border-sky-500 focus:outline-none transition">
                    <option value="percentage">Persentase (%)</option>
                    <option value="fixed">Nominal (Rp)</option>
                </select>
            </div>
            <div class="mb-6">
                <label for="discount-value" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Nilai Diskon</label>
                <input type="number" id="discount-value" class="w-full bg-white dark:bg-slate-700 dark:text-white border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" placeholder="0" min="0">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="removeDiscount()" class="bg-red-100 hover:bg-red-200 text-red-800 dark:bg-red-900/50 dark:hover:bg-red-900/80 dark:text-red-300 rounded-xl py-3 font-bold transition">Hapus</button>
                <button onclick="applyDiscount()" class="bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-3 font-bold transition">Terapkan</button>
            </div>
            <button onclick="closeModal('discount-modal')" class="w-full mt-4 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 rounded-xl py-3 font-bold transition">Tutup</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-sm shadow-2xl text-center modal-content">
            <h3 id="confirm-title" class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Konfirmasi</h3>
            <p id="confirm-message" class="text-slate-500 dark:text-slate-400 mb-6">Apakah Anda yakin?</p>
            <div class="grid grid-cols-2 gap-4">
                <button id="confirm-cancel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 rounded-xl py-2 font-bold transition">Batal</button>
                <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white rounded-xl py-2 font-bold transition">Yakin</button>
            </div>
        </div>
    </div>

    <!-- Table Modal -->
    <div id="table-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-2xl shadow-2xl modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Manajemen Meja</h3>
                <button onclick="closeModal('table-modal')" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
            </div>
            <div id="table-grid" class="grid grid-cols-4 md:grid-cols-6 gap-4"></div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventory-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-4xl shadow-2xl flex flex-col modal-content" style="height: 90vh;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Manajemen Stok & Menu</h3>
                <button onclick="closeModal('inventory-modal')" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
            </div>
            <div id="inventory-list" class="flex-grow overflow-y-auto pr-2 -mr-2"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('inventory-modal')" class="bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-2 px-5 font-bold transition">Selesai</button>
            </div>
        </div>
    </div>

    <!-- Edit Menu Modal -->
    <div id="edit-menu-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-md shadow-2xl modal-content">
            <h3 class="text-2xl font-bold mb-6 text-center text-slate-900 dark:text-white" id="edit-menu-title">Edit Menu</h3>
            <form id="edit-menu-form" onsubmit="event.preventDefault(); saveMenuEdit();">
                <input type="hidden" id="edit-menu-id">
                <div class="mb-4">
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Nama Menu</label>
                    <input type="text" id="edit-menu-name" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" required>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Harga (Rp)</label>
                    <input type="number" id="edit-menu-price" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" min="0" required>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Kategori</label>
                    <select id="edit-menu-category" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition">
                        <option value="mie">Mie</option>
                        <option value="topping">Topping</option>
                        <option value="minuman">Minuman</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Gambar</label>
                    <div class="flex items-center space-x-4">
                        <img id="edit-menu-image-preview" src="https://placehold.co/80x80/e2e8f0/94a3b8?text=Preview" class="w-20 h-20 rounded-lg object-cover bg-slate-100 dark:bg-slate-700">
                        <input type="file" id="edit-menu-image" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Stok</label>
                    <input type="number" id="edit-menu-stock" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" min="0" required>
                </div>
                <div class="mb-4">
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">HPP (Rp)</label>
                    <input type="number" id="edit-menu-hpp" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" min="0">
                </div>
                <div class="mb-4">
                    <label class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Barcode</label>
                    <input type="text" id="edit-menu-barcode" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 rounded-lg p-3 focus:border-sky-500 focus:outline-none transition" placeholder="8991234567890">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('edit-menu-modal')" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 rounded-xl py-2 px-5 font-bold transition">Batal</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-2 px-5 font-bold transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Spice Level Modal -->
    <div id="spice-level-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-md shadow-2xl text-center modal-content">
            <h3 id="spice-modal-title" class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Pilih Level Pedas</h3>
            <div class="grid grid-cols-3 sm:grid-cols-5 gap-3">
                <button onclick="confirmSpiceLevel(1)" class="flex flex-col items-center justify-center p-3 rounded-lg font-bold text-lg transition bg-slate-100 dark:bg-slate-700 hover:bg-amber-400 hover:text-white h-20">1<span id="spice-cost-1" class="text-xs font-normal mt-1"></span></button>
                <button onclick="confirmSpiceLevel(2)" class="flex flex-col items-center justify-center p-3 rounded-lg font-bold text-lg transition bg-slate-100 dark:bg-slate-700 hover:bg-amber-500 hover:text-white h-20">2<span id="spice-cost-2" class="text-xs font-normal mt-1"></span></button>
                <button onclick="confirmSpiceLevel(3)" class="flex flex-col items-center justify-center p-3 rounded-lg font-bold text-lg transition bg-slate-100 dark:bg-slate-700 hover:bg-orange-500 hover:text-white h-20">3<span id="spice-cost-3" class="text-xs font-normal mt-1"></span></button>
                <button onclick="confirmSpiceLevel(4)" class="flex flex-col items-center justify-center p-3 rounded-lg font-bold text-lg transition bg-slate-100 dark:bg-slate-700 hover:bg-red-500 hover:text-white h-20">4<span id="spice-cost-4" class="text-xs font-normal mt-1"></span></button>
                <button onclick="confirmSpiceLevel(5)" class="flex flex-col items-center justify-center p-3 rounded-lg font-bold text-lg transition bg-slate-100 dark:bg-slate-700 hover:bg-red-700 hover:text-white h-20">5<span id="spice-cost-5" class="block text-xs font-normal"></span></button>
            </div>
            <button onclick="closeModal('spice-level-modal')" class="w-full mt-6 bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 rounded-xl py-3 font-bold transition">Batal</button>
        </div>
    </div>

    <!-- Customer Management Modal -->
    <div id="customer-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-4xl shadow-2xl flex flex-col modal-content" style="height: 90vh;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Manajemen Pelanggan</h3>
                <button onclick="closeModal('customer-modal')" class="text-3xl text-slate-400 hover:text-slate-600 transition">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-grow overflow-hidden">
                <div class="md:col-span-1 flex flex-col overflow-y-auto pr-2 -mr-2">
                    <input type="text" id="customer-search-input" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2.5 mb-4 placeholder-slate-400" placeholder="Cari pelanggan...">
                    <div id="customer-list" class="flex-grow space-y-2"></div>
                </div>
                <div class="md:col-span-2 bg-slate-50 dark:bg-slate-900/50 p-6 rounded-lg">
                    <div id="customer-details-view" class="hidden">
                        <h4 class="text-xl font-bold mb-1" id="details-customer-name"></h4>
                        <p class="text-slate-500 mb-4" id="details-customer-phone"></p>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg text-center">
                                <span class="text-sm text-slate-500">Total Kunjungan</span>
                                <p class="text-2xl font-bold" id="details-customer-visits"></p>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg text-center">
                                <span class="text-sm text-slate-500">Loyalty Reward</span>
                                <p class="text-lg font-bold text-green-500" id="details-customer-reward"></p>
                            </div>
                        </div>
                        <h5 class="font-bold mt-6 mb-2">Riwayat Transaksi</h5>
                        <div id="details-customer-history" class="max-h-60 overflow-y-auto space-y-2 pr-2 -mr-2"></div>
                         <button id="select-customer-btn" class="w-full mt-6 bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-3 font-bold transition">Pilih untuk Pesanan Ini</button>
                    </div>
                    <div id="add-customer-view">
                        <h4 class="text-xl font-bold mb-4">Tambah Pelanggan Baru</h4>
                        <div class="space-y-4">
                            <div>
                                <label for="new-customer-name" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Nama Pelanggan</label>
                                <input type="text" id="new-customer-name" class="w-full bg-white dark:bg-slate-700 rounded-lg p-2.5 border-2 border-slate-200 dark:border-slate-600 focus:border-sky-500 focus:outline-none transition">
                            </div>
                            <div>
                                <label for="new-customer-phone" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Nomor Telepon (Opsional)</label>
                                <input type="tel" id="new-customer-phone" class="w-full bg-white dark:bg-slate-700 rounded-lg p-2.5 border-2 border-slate-200 dark:border-slate-600 focus:border-sky-500 focus:outline-none transition">
                            </div>
                            <button onclick="addNewCustomer()" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white rounded-xl py-3 font-bold transition">Simpan Pelanggan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal (dengan tab baru) -->
    <div id="settings-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-lg sm:max-w-2xl shadow-2xl modal-content">
            <h3 class="text-2xl font-bold mb-6 text-slate-900 dark:text-white">Pengaturan Aplikasi</h3>
            
            <div class="border-b border-slate-200 dark:border-slate-700 mb-6">
                <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                    <button onclick="switchSettingsTab(event, 'umum')" class="settings-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Umum</button>
                    <button onclick="switchSettingsTab(event, 'finansial')" class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Finansial</button>
                    <button onclick="switchSettingsTab(event, 'struk')" class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Struk</button>
                    <button onclick="switchSettingsTab(event, 'data')" class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Data & Laporan</button>
                    <button onclick="switchSettingsTab(event, 'shift')" class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Shift</button>
                    <button onclick="switchSettingsTab(event, 'level')" class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Level Pedas</button>
                    <button onclick="switchSettingsTab(event, 'meja')" class="settings-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Meja</button>
                </nav>
            </div>

            <div id="settings-content">
                <!-- Tab Umum -->
                <div id="settings-tab-umum" class="settings-tab-content space-y-4">
                    <div><label for="setting-store-name" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Nama Toko</label><input type="text" id="setting-store-name" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2.5 border-2 border-transparent focus:border-sky-500 focus:outline-none transition"></div>
                    <div><label for="setting-store-address" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Alamat Toko</label><input type="text" id="setting-store-address" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2.5 border-2 border-transparent focus:border-sky-500 focus:outline-none transition"></div>
                    <div><label for="setting-cashier-name" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Nama Kasir</label><input type="text" id="setting-cashier-name" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2.5 border-2 border-transparent focus:border-sky-500 focus:outline-none transition"></div>
                </div>
                <!-- Tab Finansial -->
                <div id="settings-tab-finansial" class="settings-tab-content space-y-4 hidden">
                    <div><label for="setting-tax-rate" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Tarif Pajak (%)</label><input type="number" id="setting-tax-rate" min="0" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2.5 border-2 border-transparent focus:border-sky-500 focus:outline-none transition"></div>
                    <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg"><label for="setting-tax-enabled" class="font-semibold text-slate-700 dark:text-slate-200">Aktifkan Pajak</label><input type="checkbox" id="setting-tax-enabled" class="h-6 w-6 rounded text-sky-600 focus:ring-sky-500"></div>
                </div>
                <!-- Tab Struk -->
                <div id="settings-tab-struk" class="settings-tab-content space-y-4 hidden">
                    <div>
                        <label for="setting-receipt-logo" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Logo Toko</label>
                        <div class="flex items-center space-x-4">
                            <img id="logo-preview" src="https://placehold.co/80x80/e2e8f0/94a3b8?text=Logo" class="w-20 h-20 rounded-lg object-contain bg-slate-100 dark:bg-slate-700">
                            <div class="flex-grow">
                                <input type="file" id="setting-receipt-logo" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100 dark:file:bg-slate-700 dark:file:text-sky-300 dark:hover:file:bg-slate-600" accept="image/png, image/jpeg">
                                <button onclick="removeLogo()" class="mt-2 text-sm text-red-500 hover:text-red-700">Hapus Logo</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="setting-receipt-footer" class="block text-slate-500 dark:text-slate-400 mb-2 font-semibold">Pesan Footer Struk</label>
                        <textarea id="setting-receipt-footer" rows="3" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2.5 border-2 border-transparent focus:border-sky-500 focus:outline-none transition" placeholder="Contoh: Terima kasih! Follow IG @mieayamabdillah"></textarea>
                    </div>
                    <h4 class="font-bold pt-2">Opsi Tampilan Nota</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg"><label for="setting-receipt-show-cashier" class="font-semibold text-slate-700 dark:text-slate-200">Tampilkan Nama Kasir</label><input type="checkbox" id="setting-receipt-show-cashier" class="h-5 w-5 rounded text-sky-600 focus:ring-sky-500"></div>
                        <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg"><label for="setting-receipt-show-order-type" class="font-semibold text-slate-700 dark:text-slate-200">Tampilkan Tipe Pesanan</label><input type="checkbox" id="setting-receipt-show-order-type" class="h-5 w-5 rounded text-sky-600 focus:ring-sky-500"></div>
                    </div>
                </div>
                <!-- Tab Data & Laporan -->
                <div id="settings-tab-data" class="settings-tab-content space-y-4 hidden">
                    <div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                        <h4 class="font-bold text-slate-800 dark:text-slate-200">Ekspor Semua Data</h4>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Unduh semua data transaksi sebagai file JSON untuk backup.</p>
                        <button onclick="exportData()" class="bg-green-500 hover:bg-green-600 text-white rounded-lg py-2 px-4 font-bold transition text-sm">Ekspor Transaksi</button>
                    </div>
                    <div class="p-4 bg-red-50 dark:bg-red-900/30 border-l-4 border-red-400 rounded-lg">
                        <h4 class="font-bold text-red-800 dark:text-red-300">Zona Berbahaya</h4>
                        <p class="text-sm text-red-600 dark:text-red-400 mb-3">Tindakan ini akan menghapus semua data transaksi dan mengembalikan stok ke awal. Tindakan ini tidak dapat diurungkan.</p>
                        <button onclick="confirmResetData()" class="bg-red-500 hover:bg-red-600 text-white rounded-lg py-2 px-4 font-bold transition text-sm">Reset Data Aplikasi</button>
                    </div>
                </div>
                <!-- Tab Shift -->
                <div id="settings-tab-shift" class="settings-tab-content space-y-4 hidden">
                    <div class="p-4 bg-lime-50 dark:bg-lime-900/30 rounded-lg">
                        <h4 class="font-bold text-lime-800 dark:text-lime-300">Manajemen Shift</h4>
                        <p class="text-sm text-lime-600 dark:text-lime-400 mb-3">Kelola shift kasir dan lihat laporan per shift.</p>
                        <button onclick="showClockInModal()" class="bg-lime-500 hover:bg-lime-600 text-white rounded-lg py-2 px-4 font-bold transition text-sm mr-2">Clock In</button>
                        <button onclick="showClockOutModal()" class="bg-orange-500 hover:bg-orange-600 text-white rounded-lg py-2 px-4 font-bold transition text-sm">Clock Out</button>
                        <div class="mt-4">
                            <h5 class="font-semibold mb-2">Riwayat Shift</h5>
                            <div id="shift-history-list" class="max-h-40 overflow-y-auto text-sm space-y-1"></div>
                        </div>
                    </div>
                </div>
                <!-- Tab Level Pedas -->
                <div id="settings-tab-level" class="settings-tab-content space-y-4 hidden">
                    <h4 class="font-bold text-slate-800 dark:text-slate-200">Biaya Tambahan Level Pedas</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Atur biaya tambahan untuk setiap level pedas (Rp).</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-slate-500 dark:text-slate-400 mb-1">Level 1</label><input type="number" id="setting-spice-1" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2" value="0"></div>
                        <div><label class="block text-slate-500 dark:text-slate-400 mb-1">Level 2</label><input type="number" id="setting-spice-2" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2" value="0"></div>
                        <div><label class="block text-slate-500 dark:text-slate-400 mb-1">Level 3</label><input type="number" id="setting-spice-3" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2" value="2000"></div>
                        <div><label class="block text-slate-500 dark:text-slate-400 mb-1">Level 4</label><input type="number" id="setting-spice-4" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2" value="4000"></div>
                        <div><label class="block text-slate-500 dark:text-slate-400 mb-1">Level 5</label><input type="number" id="setting-spice-5" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2" value="6000"></div>
                    </div>
                </div>
                <!-- Tab Meja -->
                <div id="settings-tab-meja" class="settings-tab-content space-y-4 hidden">
                    <h4 class="font-bold text-slate-800 dark:text-slate-200">Jumlah Meja</h4>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-3">Atur jumlah meja yang tersedia (min 1, max 20).</p>
                    <div class="flex items-center space-x-4">
                        <input type="number" id="setting-table-count" min="1" max="20" class="w-24 bg-slate-100 dark:bg-slate-700 rounded-lg p-2 text-center" value="12">
                        <button onclick="updateTableCount()" class="bg-sky-500 hover:bg-sky-600 text-white rounded-lg py-2 px-4 font-bold transition">Terapkan</button>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">Perubahan akan langsung menyesuaikan tata letak meja.</p>
                </div>
            </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button onclick="closeModal('settings-modal')" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 rounded-xl py-2 px-5 font-bold transition">Batal</button>
                <button onclick="saveSettings()" id="save-settings-btn" class="bg-sky-500 hover:bg-sky-600 text-white rounded-xl py-2 px-5 font-bold transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Clock In -->
    <div id="clockin-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-sm shadow-2xl modal-content">
            <h3 class="text-2xl font-bold mb-4 text-center">Clock In</h3>
            <div class="mb-4">
                <label for="clockin-cashier" class="block text-slate-500 dark:text-slate-400 mb-2">Nama Kasir</label>
                <input type="text" id="clockin-cashier" class="w-full bg-white dark:bg-slate-700 rounded-lg p-3 border-2 border-slate-200 dark:border-slate-600" value="Kasir 1">
            </div>
            <div class="mb-4">
                <label for="clockin-startcash" class="block text-slate-500 dark:text-slate-400 mb-2">Modal Awal</label>
                <input type="number" id="clockin-startcash" class="w-full bg-white dark:bg-slate-700 rounded-lg p-3 border-2 border-slate-200 dark:border-slate-600" value="0">
            </div>
            <button onclick="clockIn()" class="w-full bg-lime-500 hover:bg-lime-600 text-white rounded-xl py-3 font-bold">Mulai Shift</button>
            <button onclick="closeModal('clockin-modal')" class="w-full mt-2 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded-xl py-2 font-bold">Batal</button>
        </div>
    </div>

    <!-- Modal Clock Out -->
    <div id="clockout-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-sm shadow-2xl modal-content">
            <h3 class="text-2xl font-bold mb-4 text-center">Clock Out</h3>
            <p class="text-center mb-4">Apakah Anda yakin ingin mengakhiri shift?</p>
            <div id="shift-summary" class="bg-slate-100 dark:bg-slate-900 p-4 rounded-lg mb-4 text-sm">
                <div class="flex justify-between"><span>Modal Awal:</span> <span id="summary-startcash">Rp 0</span></div>
                <div class="flex justify-between"><span>Penjualan Tunai:</span> <span id="summary-cashsales">Rp 0</span></div>
                <div class="flex justify-between font-bold"><span>Total di Laci:</span> <span id="summary-totalcash">Rp 0</span></div>
            </div>
            <button onclick="clockOut()" class="w-full bg-red-500 hover:bg-red-600 text-white rounded-xl py-3 font-bold">Akhiri Shift</button>
            <button onclick="closeModal('clockout-modal')" class="w-full mt-2 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded-xl py-2 font-bold">Batal</button>
        </div>
    </div>

    <!-- Modal Laporan Shift -->
    <div id="shift-report-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 w-full max-w-2xl shadow-2xl modal-content">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold">Laporan Shift</h3>
                <p id="shift-report-detail" class="text-slate-500"></p>
            </div>
            <div id="shift-report-content" class="space-y-4"></div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('shift-report-modal')" class="bg-sky-500 hover:bg-sky-600 text-white rounded-lg py-2 px-5 font-bold">Tutup</button>
            </div>
        </div>
    </div>

    <!-- End of Shift Report Modal -->
    <div id="end-of-shift-report-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200 rounded-2xl p-6 w-full max-w-2xl shadow-2xl modal-content">
            <div id="shift-report-print-area" class="printable-area p-8">
                <div class="text-center mb-8">
                    <h3 class="text-3xl font-bold" id="shift-report-store-name"></h3>
                    <p class="text-slate-500 dark:text-slate-400">Laporan Akhir Shift</p>
                    <p id="shift-report-cashier" class="text-slate-500 dark:text-slate-400 text-sm"></p>
                    <p id="shift-report-time" class="text-slate-500 dark:text-slate-400 text-sm"></p>
                </div>
                <div class="space-y-4">
                    <h4 class="text-xl font-bold">Ringkasan Keuangan</h4>
                    <div class="border-t dark:border-slate-600 pt-4 space-y-2">
                        <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">Modal Awal:</span><span id="shift-report-start-cash" class="font-semibold"></span></div>
                        <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">Penjualan Tunai:</span><span id="shift-report-cash-sales" class="font-semibold"></span></div>
                        <div class="flex justify-between font-bold text-lg border-t dark:border-slate-600 pt-2"><span class="text-slate-800 dark:text-slate-200">Total Uang Tunai di Laci:</span><span id="shift-report-expected-cash" class="text-green-600 dark:text-green-500"></span></div>
                    </div>
                     <h4 class="text-xl font-bold pt-4">Ringkasan Penjualan</h4>
                     <div class="border-t dark:border-slate-600 pt-4 space-y-2">
                        <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">Penjualan Non-Tunai (QRIS, Debit):</span><span id="shift-report-noncash-sales" class="font-semibold"></span></div>
                        <div class="flex justify-between"><span class="text-slate-600 dark:text-slate-400">Total Diskon Diberikan:</span><span id="shift-report-total-discount" class="font-semibold text-red-500"></span></div>
                        <div class="flex justify-between font-bold text-lg border-t dark:border-slate-600 pt-2"><span class="text-slate-800 dark:text-slate-200">Total Penjualan (Kotor):</span><span id="shift-report-gross-sales" class="text-sky-600 dark:text-sky-500"></span></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-between">
                <button onclick="closeModal('end-of-shift-report-modal')" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-bold py-2 px-4 rounded-lg transition">Batal</button>
                <button onclick="endShift()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">Konfirmasi & Tutup Shift</button>
            </div>
        </div>
    </div>

    <!-- EOD Report Modal -->
    <div id="eod-report-modal" class="fixed inset-0 bg-slate-900 bg-opacity-30 modal-backdrop flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white text-slate-900 rounded-2xl p-6 w-full max-w-2xl shadow-2xl modal-content">
            <div id="eod-report-print-area" class="printable-area p-8">
                <div class="text-center mb-8">
                    <h3 class="text-3xl font-bold text-slate-900" id="eod-store-name"></h3>
                    <p class="text-slate-500">Laporan Penjualan Harian</p>
                    <p id="eod-date" class="text-slate-500 text-sm"></p>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-8 text-center">
                    <div class="p-4 bg-slate-100 rounded-lg"><span class="block text-sm text-slate-500">Total Penjualan</span><span id="eod-total-revenue" class="text-2xl font-bold"></span></div>
                    <div class="p-4 bg-slate-100 rounded-lg"><span class="block text-sm text-slate-500">Jumlah Transaksi</span><span id="eod-total-transactions" class="text-2xl font-bold"></span></div>
                    <div class="p-4 bg-slate-100 rounded-lg"><span class="block text-sm text-slate-500">Kasir Bertugas</span><span id="eod-cashier-name" class="text-2xl font-bold"></span></div>
                </div>
                <div>
                    <h4 class="text-xl font-bold mb-4">Rincian Pembayaran</h4>
                    <div id="eod-payment-methods" class="space-y-2 border-t pt-4"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-between">
                <button onclick="closeModal('eod-report-modal')" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg transition">Tutup</button>
                <button onclick="printEndOfDayReport()" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">Cetak Laporan</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== ICONS ====================
        const ICONS = {
            note: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.4 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.4z"></path><path d="M13 2v6h6"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>`,
            minus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`
        };

        // Data Menu Mie Ayam Abdillah (dengan barcode)
        let initialMenuItems = [
            { id: 1, name: 'Mie Ayam Biasa', price: 12000, category: 'mie', image: 'https://placehold.co/300x300/ef4444/white?text=Mie+Ayam+Biasa', stock: 20, hpp: 6000, barcode: '8991234567890' },
            { id: 2, name: 'Mie Ayam Bakso', price: 15000, category: 'mie', image: 'https://placehold.co/300x300/f97316/white?text=Mie+Ayam+Bakso', stock: 15, hpp: 8000, barcode: '8991234567891' },
            { id: 3, name: 'Mie Ayam Ceker', price: 15000, category: 'mie', image: 'https://placehold.co/300x300/84cc16/white?text=Mie+Ayam+Ceker', stock: 25, hpp: 8000, barcode: '8991234567892' },
            { id: 4, name: 'Mie Ayam Pangsit', price: 13000, category: 'mie', image: 'https://placehold.co/300x300/10b981/white?text=Mie+Ayam+Pangsit', stock: 20, hpp: 6500, barcode: '8991234567893' },
            { id: 5, name: 'Mie Ayam Spesial', price: 18000, category: 'mie', image: 'https://placehold.co/300x300/6366f1/white?text=Mie+Ayam+Spesial', stock: 18, hpp: 9000, barcode: '8991234567894' },
            { id: 6, name: 'Mie Ayam Yamin', price: 14000, category: 'mie', image: 'https://placehold.co/300x300/8b5cf6/white?text=Mie+Ayam+Yamin', stock: 15, hpp: 7000, barcode: '8991234567895' },
            { id: 7, name: 'Mie Ayam Iritasi', price: 11000, category: 'mie', image: 'https://placehold.co/300x300/a855f7/white?text=Mie+Ayam+Iritasi', stock: 20, hpp: 5500, barcode: '8991234567896' },
            { id: 8, name: 'Mie Ayam Komplit', price: 20000, category: 'mie', image: 'https://placehold.co/300x300/ec4899/white?text=Mie+Ayam+Komplit', stock: 22, hpp: 10000, barcode: '8991234567897' },
            { id: 9, name: 'Mie Ayam Polos', price: 10000, category: 'mie', image: 'https://placehold.co/300x300/f43f5e/white?text=Mie+Ayam+Polos', stock: 22, hpp: 5000, barcode: '8991234567898' },
            { id: 10, name: 'Mie Ayam Goreng', price: 13000, category: 'mie', image: 'https://placehold.co/300x300/ef4444/white?text=Mie+Ayam+Goreng', stock: 15, hpp: 6500, barcode: '8991234567899' },
            { id: 11, name: 'Mie Ayam Kuah', price: 12000, category: 'mie', image: 'https://placehold.co/300x300/0ea5e9/white?text=Mie+Ayam+Kuah', stock: 20, hpp: 6000, barcode: '8991234567800' },
            { id: 12, name: 'Mie Ayam Original', price: 12000, category: 'mie', image: 'https://placehold.co/300x300/06b6d4/white?text=Mie+Ayam+Original', stock: 20, hpp: 6000, barcode: '8991234567801' },
            { id: 13, name: 'Mie Ayam Pedes', price: 13000, category: 'mie', image: 'https://placehold.co/300x300/f59e0b/white?text=Mie+Ayam+Pedes', stock: 15, hpp: 6500, barcode: '8991234567802' },
            { id: 14, name: 'Mie Ayam Keju', price: 15000, category: 'mie', image: 'https://placehold.co/300x300/facc15/white?text=Mie+Ayam+Keju', stock: 18, hpp: 7500, barcode: '8991234567803' },
            { id: 15, name: 'Mie Ayam Telur', price: 12000, category: 'mie', image: 'https://placehold.co/300x300/e11d48/white?text=Mie+Ayam+Telur', stock: 15, hpp: 6000, barcode: '8991234567804' },
            { id: 16, name: 'Mie Ayam Jamur', price: 14000, category: 'mie', image: 'https://placehold.co/300x300/be123c/white?text=Mie+Ayam+Jamur', stock: 15, hpp: 7000, barcode: '8991234567805' },
            { id: 17, name: 'Bakso', price: 2000, category: 'topping', image: 'https://placehold.co/300x300/8b5cf6/white?text=Bakso', stock: 50, hpp: 1000, barcode: '8991234567806' },
            { id: 18, name: 'Pangsit', price: 2000, category: 'topping', image: 'https://placehold.co/300x300/a855f7/white?text=Pangsit', stock: 50, hpp: 1000, barcode: '8991234567807' },
            { id: 19, name: 'Ceker', price: 3000, category: 'topping', image: 'https://placehold.co/300x300/f59e0b/white?text=Ceker', stock: 40, hpp: 1500, barcode: '8991234567808' },
            { id: 20, name: 'Telur', price: 3000, category: 'topping', image: 'https://placehold.co/300x300/10b981/white?text=Telur', stock: 40, hpp: 1500, barcode: '8991234567809' },
            { id: 21, name: 'Dumpling', price: 3000, category: 'topping', image: 'https://placehold.co/300x300/6366f1/white?text=Dumpling', stock: 40, hpp: 1500, barcode: '8991234567810' },
            { id: 22, name: 'Jamur', price: 5000, category: 'topping', image: 'https://placehold.co/300x300/ec4899/white?text=Jamur', stock: 30, hpp: 2500, barcode: '8991234567811' },
            { id: 23, name: 'Sosis', price: 2000, category: 'topping', image: 'https://placehold.co/300x300/f97316/white?text=Sosis', stock: 100, hpp: 1000, barcode: '8991234567812' },
            { id: 24, name: 'Makaroni', price: 2000, category: 'topping', image: 'https://placehold.co/300x300/0ea5e9/white?text=Makaroni', stock: 100, hpp: 500, barcode: '8991234567813' },
            { id: 25, name: 'Es Teh Manis', price: 3000, category: 'minuman', image: 'https://placehold.co/300x300/3b82f6/white?text=Es+Teh+Manis', stock: 50, hpp: 1000, barcode: '8991234567814' },
            { id: 26, name: 'Es Jeruk', price: 4000, category: 'minuman', image: 'https://placehold.co/300x300/06b6d4/white?text=Es+Jeruk', stock: 50, hpp: 1500, barcode: '8991234567815' },
            { id: 27, name: 'Pop Ice', price: 5000, category: 'minuman', image: 'https://placehold.co/300x300/a855f7/white?text=Pop+Ice', stock: 50, hpp: 2500, barcode: '8991234567816' },
            { id: 28, name: 'Nutrisari', price: 4000, category: 'minuman', image: 'https://placehold.co/300x300/f97316/white?text=Nutrisari', stock: 50, hpp: 2000, barcode: '8991234567817' },
        ];
        let menuItems = JSON.parse(JSON.stringify(initialMenuItems));

        // --- APLIKASI STATE ---
        let cart = [];
        let transactions = [];
        let customers = [];
        let heldOrders = [];
        let currentShift = { active: false, startTime: null, startCash: 0, transactions: [] };
        let splitBillState = { active: false, originalCart: [], newCart: [] };

        let currentCustomerId = null;
        let currentCustomerType = 'guest';
        let currentFilter = 'semua';
        let currentOrderType = 'Dine-In';
        let discount = { type: 'fixed', value: 0 };
        let salesChart = null;
        let hourlySalesChart = null;
        let currentTable = null;
        let tables = Array.from({ length: 12 }, (_, i) => ({ id: i + 1, name: `M${i + 1}`, status: 'available' }));
        let settings = {
            storeName: 'Mie Ayam Abdillah',
            storeAddress: 'Jl. Mie Ayam No. 1, Wonosobo',
            cashierName: 'Kasir 1',
            taxRate: 10,
            taxEnabled: true,
            receiptFooter: 'Terima kasih! Follow IG @mieayamabdillah',
            storeLogo: null,
            receiptShowCashier: true,
            receiptShowOrderType: true,
            darkMode: false,
            spiceLevelCosts: { 1: 0, 2: 0, 3: 2000, 4: 4000, 5: 6000 },
            tableCount: 12
        };
        let pendingItemForLevel = null;
        let currentPaymentMethod = 'Tunai';

        // --- FITUR TAMBAHAN ---
        let shiftHistory = [];
        let scannerActive = false;

        // --- DOM ELEMENTS (disingkat, tapi dalam kode asli semua harus ada) ---
        const allDOM = {
            mainContainer: document.getElementById('main-container'),
            shiftModal: document.getElementById('shift-modal'),
            menuGrid: document.getElementById('menu-grid'),
            orderList: document.getElementById('order-list'),
            subtotalEl: document.getElementById('subtotal'),
            taxEl: document.getElementById('tax'),
            totalEl: document.getElementById('total'),
            payButton: document.getElementById('pay-button'),
            holdButton: document.getElementById('hold-button'),
            emptyCartMessage: document.getElementById('empty-cart-message'),
            paymentModal: document.getElementById('payment-modal'),
            totalTagihanInput: document.getElementById('total-tagihan'),
            uangDiterimaInput: document.getElementById('uang-diterima'),
            kembalianEl: document.getElementById('kembalian'),
            confirmPaymentButton: document.getElementById('confirm-payment-button'),
            receiptModal: document.getElementById('receipt-modal'),
            historyModal: document.getElementById('history-modal'),
            dashboardModal: document.getElementById('dashboard-modal'),
            discountModal: document.getElementById('discount-modal'),
            discountAmountEl: document.getElementById('discount-amount'),
            customerNameDisplay: document.getElementById('customer-name-display'),
            clearCustomerBtn: document.getElementById('clear-customer-btn'),
            customerSelectionArea: document.getElementById('customer-selection-area'),
            tableModal: document.getElementById('table-modal'),
            tableGrid: document.getElementById('table-grid'),
            tableManagementSection: document.getElementById('table-management-section'),
            tableDisplay: document.getElementById('table-display'),
            tableNumberDisplay: document.getElementById('table-number-display'),
            settingsModal: document.getElementById('settings-modal'),
            inventoryModal: document.getElementById('inventory-modal'),
            inventoryList: document.getElementById('inventory-list'),
            headerStoreName: document.getElementById('header-store-name'),
            taxRateDisplay: document.getElementById('tax-rate-display'),
            spiceLevelModal: document.getElementById('spice-level-modal'),
            spiceModalTitle: document.getElementById('spice-modal-title'),
            taxRow: document.getElementById('tax-row'),
            searchBar: document.getElementById('search-bar'),
            searchClearBtn: document.getElementById('search-clear-btn'),
            cashPaymentSection: document.getElementById('cash-payment-section'),
            changeSection: document.getElementById('change-section'),
            eodReportModal: document.getElementById('eod-report-modal'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            sunIcon: document.getElementById('sun-icon'),
            moonIcon: document.getElementById('moon-icon'),
            customerModal: document.getElementById('customer-modal'),
            customerList: document.getElementById('customer-list'),
            customerSearchInput: document.getElementById('customer-search-input'),
            addCustomerView: document.getElementById('add-customer-view'),
            customerDetailsView: document.getElementById('customer-details-view'),
            activeOrdersModal: document.getElementById('active-orders-modal'),
            activeOrdersList: document.getElementById('active-orders-list'),
            activeOrdersBadge: document.getElementById('active-orders-badge'),
            splitBillModal: document.getElementById('split-bill-modal'),
            endOfShiftReportModal: document.getElementById('end-of-shift-report-modal'),
        };

        const qrisSection = document.getElementById('qris-payment-section');
        const qrisInput = document.getElementById('qris-code');
        const orderNote = document.getElementById('order-note');
        const menuSkeleton = document.getElementById('menu-skeleton');
        const dashboardCashierFilter = document.getElementById('dashboard-cashier-filter');

        // ==================== UTILITY FUNCTIONS ====================
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        
        function showConfirm(title, message, onOk) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            showModal('confirm-modal');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            okBtn.onclick = () => { onOk(); closeModal('confirm-modal'); };
            cancelBtn.onclick = () => closeModal('confirm-modal');
        }

        function showToast(message, type = 'info') {
            playSound(type);
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgColor = 'bg-slate-900';
            if (type === 'error') bgColor = 'error';
            if (type === 'success') bgColor = 'success';
            
            toast.className = `toast ${bgColor}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        // Fungsi suara notifikasi
        function playSound(type) {
            const sounds = {
                success: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3',
                error: 'https://www.soundjay.com/misc/sounds/buzzer-or-wrong-answer-01.mp3',
                add: 'https://www.soundjay.com/misc/sounds/beep-07.mp3',
                info: 'https://www.soundjay.com/misc/sounds/beep-09.mp3'
            };
            if (sounds[type]) {
                new Audio(sounds[type]).play().catch(e => console.log('Audio play failed:', e));
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderMenu(searchTerm = '') {
            menuSkeleton.classList.remove('hidden');
            allDOM.menuGrid.classList.add('hidden');
            
            setTimeout(() => {
                const lowerSearchTerm = searchTerm.toLowerCase();
                const filteredItems = menuItems.filter(item => 
                    (currentFilter === 'semua' || item.category === currentFilter) &&
                    item.name.toLowerCase().includes(lowerSearchTerm)
                );
                
                const menuHTML = filteredItems.map(item => {
                    const isOutOfStock = item.stock <= 0;
                    const stockColor = item.stock <= 5 ? 'text-red-500' : 'text-slate-400 dark:text-slate-500';
                    return `<div class="bg-white dark:bg-slate-800 rounded-2xl p-4 flex flex-col text-center transition-all duration-300 shadow-lg shadow-slate-200/50 dark:shadow-black/20 hover:shadow-xl hover:-translate-y-1 ${isOutOfStock ? 'item-out-of-stock' : 'cursor-pointer'}" onclick="${isOutOfStock ? '' : `handleItemClick(${item.id})`}">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-32 object-cover rounded-xl mb-3" onerror="this.onerror=null;this.src='https://placehold.co/300x300/ef4444/white?text=Error';">
                        <h3 class="font-bold text-sm sm:text-md flex-grow text-slate-800 dark:text-slate-200">${item.name}</h3>
                        <p class="text-sky-600 font-semibold mt-1">${formatRupiah(item.price)}</p>
                        <p class="text-xs ${stockColor} font-semibold mt-2">Stok: ${item.stock}</p>
                        ${isOutOfStock ? '<div class="overlay"><span class="overlay-text">Stok Habis</span></div>' : ''}
                    </div>`;
                }).join('');
                
                allDOM.menuGrid.innerHTML = menuHTML || `<p class="col-span-full text-center text-slate-500 mt-8">Menu tidak ditemukan.</p>`;
                menuSkeleton.classList.add('hidden');
                allDOM.menuGrid.classList.remove('hidden');
            }, 300);
        }

        function renderCart() {
            if (cart.length === 0) {
                allDOM.orderList.innerHTML = '';
                allDOM.emptyCartMessage.style.display = 'block';
            } else {
                allDOM.emptyCartMessage.style.display = 'none';
                
                const cartHTML = cart.map(item => {
                    const noteHTML = item.note ? `<p class="text-xs text-amber-600 truncate italic">"${item.note}"</p>` : '';
                    const levelHTML = item.level ? `<span class="text-xs font-bold text-red-500 ml-2">Lv. ${item.level}</span>` : '';
                    return `<div class="flex items-center mb-3 bg-slate-50 dark:bg-slate-900/70 p-3 rounded-xl">
                        <img src="${item.image}" class="w-12 h-12 rounded-lg object-cover mr-4">
                        <div class="flex-grow">
                            <p class="font-bold text-sm flex items-center">${item.name}${levelHTML}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">${item.quantity} x ${formatRupiah(item.finalPrice)}</p>
                            ${noteHTML}
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="addNoteToItem(${item.cartId})" class="w-8 h-8 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-100 hover:text-slate-900 dark:hover:bg-slate-700 rounded-lg font-bold flex items-center justify-center transition">${ICONS.note}</button>
                            <button onclick="updateQuantity(${item.cartId}, -1)" class="w-8 h-8 bg-white dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-red-100 hover:text-red-600 dark:hover:bg-red-900/50 dark:hover:text-red-400 rounded-lg font-bold flex items-center justify-center transition">${ICONS.minus}</button>
                            <span class="w-8 text-center font-bold">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.cartId}, 1)" class="w-8 h-8 bg-sky-500 text-white hover:bg-sky-600 rounded-lg font-bold flex items-center justify-center transition">${ICONS.plus}</button>
                        </div>
                    </div>`;
                }).join('');
                allDOM.orderList.innerHTML = cartHTML;
            }
            updateSummary();
        }

        function updateSummary() {
            const currentCart = splitBillState.active ? splitBillState.newCart : cart;
            const subtotal = currentCart.reduce((sum, item) => sum + (item.finalPrice * item.quantity), 0);
            let discountValue = 0;
            if (!splitBillState.active) {
                 discountValue = discount.type === 'percentage' ? subtotal * (discount.value / 100) : discount.value;
                 discountValue = Math.min(subtotal, discountValue);
            }
            const totalAfterDiscount = subtotal - discountValue;
            
            let tax = 0;
            if (settings.taxEnabled) {
                tax = totalAfterDiscount * (settings.taxRate / 100);
                allDOM.taxRow.style.display = 'flex';
            } else {
                allDOM.taxRow.style.display = 'none';
            }
            
            const total = totalAfterDiscount + tax;
            allDOM.subtotalEl.textContent = formatRupiah(subtotal);
            allDOM.discountAmountEl.textContent = `- ${formatRupiah(discountValue)}`;
            allDOM.taxEl.textContent = formatRupiah(tax);
            allDOM.totalEl.textContent = formatRupiah(total);
            allDOM.payButton.disabled = currentCart.length === 0;
            allDOM.holdButton.disabled = currentCart.length === 0 || currentOrderType !== 'Dine-In';
        }

        // --- CART LOGIC ---
        function handleItemClick(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (item.category === 'mie') {
                pendingItemForLevel = item;
                allDOM.spiceModalTitle.textContent = `Pilih Level Pedas untuk ${item.name}`;
                renderSpiceLevelCosts();
                showModal('spice-level-modal');
            } else {
                addToCart(itemId);
            }
        }

        function renderSpiceLevelCosts() {
            for (let i = 1; i <= 5; i++) {
                const costEl = document.getElementById(`spice-cost-${i}`);
                const cost = settings.spiceLevelCosts[i] || 0;
                costEl.textContent = cost > 0 ? `+${formatRupiah(cost)}` : 'Gratis';
            }
        }

        function confirmSpiceLevel(level) {
            if (pendingItemForLevel) {
                addToCart(pendingItemForLevel.id, level);
                closeModal('spice-level-modal');
            }
        }

        function addToCart(itemId, level = null) {
            const itemData = menuItems.find(item => item.id === itemId);
            if (itemData.stock <= 0) { showToast('Stok produk habis!', 'error'); return; }

            const spiceCost = level ? (settings.spiceLevelCosts[level] || 0) : 0;
            const finalPrice = itemData.price + spiceCost;
            
            const existingCartItem = cart.find(item => item.id === itemId && item.level === level && !item.note);
            
            if (existingCartItem) {
                existingCartItem.quantity++;
            } else {
                cart.push({ ...itemData, quantity: 1, note: '', level: level, spiceCost: spiceCost, finalPrice: finalPrice, cartId: Date.now() });
            }
            itemData.stock--;
            playSound('add');
            showToast(`${itemData.name} ${level ? `Lv. ${level}`: ''} ditambahkan`);
            renderMenu(allDOM.searchBar.value); renderCart(); saveData();
        }

        function updateQuantity(cartId, change) {
            const itemInCart = cart.find(item => item.cartId === cartId);
            const menuItem = menuItems.find(item => item.id === itemInCart.id);
            if (!itemInCart) return;
            if (change > 0 && menuItem.stock <= 0) { showToast(`Stok ${menuItem.name} habis.`, 'error'); return; }
            
            itemInCart.quantity += change;
            menuItem.stock -= change;

            if (itemInCart.quantity <= 0) {
                const cartIndex = cart.findIndex(item => item.cartId === cartId);
                if (cartIndex > -1) {
                    menuItem.stock += 1;
                    cart.splice(cartIndex, 1);
                }
            }
            renderMenu(allDOM.searchBar.value); renderCart(); saveData();
        }
        
        function addNoteToItem(cartId) {
            const itemInCart = cart.find(item => item.cartId === cartId);
            if (itemInCart) {
                const quickOptions = ['Tidak pakai bawang', 'Pedas ekstra', 'Kuah banyak', 'Kuah sedikit', 'Pisah wadah'];
                const note = prompt('Masukkan catatan untuk item ini (atau pilih opsi di bawah):\n' + quickOptions.join(', '), itemInCart.note);
                if (note !== null) { 
                    itemInCart.note = note; 
                    renderCart(); 
                }
            }
        }

        function confirmCancelOrder() { if (cart.length > 0) { showConfirm('Batalkan Pesanan?', 'Semua item akan dihapus dari pesanan saat ini. Stok akan dikembalikan.', cancelOrder); } }

        function resetOrderState(restoreStock = true) {
            if (restoreStock) {
                cart.forEach(cartItem => {
                    const menuItem = menuItems.find(item => item.id === cartItem.id);
                    if (menuItem) menuItem.stock += cartItem.quantity;
                });
            }
            cart = [];
            setCustomerType('guest');
            if(currentTable !== null) {
                const table = tables.find(t => t.id === currentTable);
                if(table && !heldOrders.some(o => o.table === currentTable)) {
                    table.status = 'available';
                }
            }
            currentTable = null;
            allDOM.tableDisplay.classList.add('hidden');
            removeDiscount();
            renderCart();
            renderMenu(allDOM.searchBar.value);
            saveData();
        }

        function cancelOrder() {
            resetOrderState(true);
        }

        function setOrderType(type) {
            currentOrderType = type;
            document.querySelectorAll('.order-type-btn').forEach(btn => btn.classList.remove('active-order-type'));
            document.getElementById(`order-type-${type.toLowerCase().replace(' ', '-')}`).classList.add('active-order-type');
            allDOM.tableManagementSection.style.display = type === 'Dine-In' ? 'block' : 'none';
            allDOM.holdButton.disabled = type !== 'Dine-In';

            if(type !== 'Dine-In' && currentTable) {
                const table = tables.find(t => t.id === currentTable);
                if(table) table.status = 'available';
                currentTable = null;
                allDOM.tableDisplay.classList.add('hidden');
            }
        }
        
        // --- SCANNER BARCODE ---
        function toggleScanner() {
            if (scannerActive) {
                Quagga.stop();
                document.getElementById('scanner').style.display = 'none';
                scannerActive = false;
            } else {
                startScanner();
            }
        }

        function startScanner() {
            const video = document.getElementById('scanner');
            video.style.display = 'block';
            scannerActive = true;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: video,
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: ["ean_reader", "code_128_reader", "code_39_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    showToast('Gagal mengakses kamera', 'error');
                    video.style.display = 'none';
                    scannerActive = false;
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(data => {
                const barcode = data.codeResult.code;
                const item = menuItems.find(i => i.barcode === barcode);
                if (item) {
                    addToCart(item.id);
                    showToast(`Item ${item.name} ditambahkan`, 'success');
                } else {
                    showToast('Barcode tidak ditemukan', 'error');
                }
                Quagga.stop();
                video.style.display = 'none';
                scannerActive = false;
            });
        }

        // --- SERVICE WORKER (PWA) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('Service Worker registered', reg);
                }).catch(err => {
                    console.log('Service Worker registration failed', err);
                });
            });
        }

        // --- MODAL & PAYMENT LOGIC ---
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('show');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function calculateTotal(cartToCalc = cart) {
            const subtotal = cartToCalc.reduce((sum, item) => sum + (item.finalPrice * item.quantity), 0);
            let discountValue = 0;
            if (!splitBillState.active) {
                discountValue = discount.type === 'percentage' ? subtotal * (discount.value / 100) : discount.value;
                discountValue = Math.min(subtotal, discountValue);
            }
            const totalAfterDiscount = subtotal - discountValue;
            let tax = settings.taxEnabled ? totalAfterDiscount * (settings.taxRate / 100) : 0;
            return totalAfterDiscount + tax;
        }

        function showPaymentModal() {
            if (cart.length === 0) { showToast('Keranjang masih kosong!', 'error'); return; }
            if (currentOrderType === 'Dine-In' && currentTable === null) { showToast('Pilih meja terlebih dahulu untuk pesanan Dine-In!', 'error'); return; }
            
            const total = calculateTotal();
            allDOM.totalTagihanInput.value = formatRupiah(total);
            allDOM.uangDiterimaInput.value = '';
            allDOM.kembalianEl.textContent = formatRupiah(0);
            document.getElementById('split-bill-button').style.display = cart.length > 1 ? 'block' : 'none';
            selectPaymentMethod('Tunai', { target: document.querySelector('.payment-method-btn')}); 
            showModal('payment-modal');
            allDOM.uangDiterimaInput.focus();
        }
        
        function calculateChange() {
            const total = calculateTotal(splitBillState.active ? splitBillState.newCart : cart);
            const diterima = parseFloat(allDOM.uangDiterimaInput.value) || 0;
            const kembalian = diterima - total;
            allDOM.confirmPaymentButton.disabled = kembalian < 0;
            allDOM.kembalianEl.textContent = formatRupiah(kembalian >= 0 ? kembalian : 0);
        }
        allDOM.uangDiterimaInput.addEventListener('input', calculateChange);
        
        function setQuickCash(amount) {
            const total = calculateTotal(splitBillState.active ? splitBillState.newCart : cart);
            if (amount === 'pas') {
                allDOM.uangDiterimaInput.value = Math.ceil(total);
            } else { allDOM.uangDiterimaInput.value = amount; }
            calculateChange();
        }

        function applyDiscount() { discount.type = document.getElementById('discount-type').value; discount.value = parseFloat(document.getElementById('discount-value').value) || 0; updateSummary(); closeModal('discount-modal'); }
        function removeDiscount() { discount = { type: 'fixed', value: 0 }; updateSummary(); }

        function selectPaymentMethod(method, event) {
            currentPaymentMethod = method;
            document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('active-order-type'));
            event.target.classList.add('active-order-type');
            if (method === 'Tunai') {
                allDOM.cashPaymentSection.style.display = 'block';
                allDOM.changeSection.style.display = 'flex';
                qrisSection.classList.add('hidden');
                allDOM.confirmPaymentButton.disabled = false;
                calculateChange();
            } else if (method === 'QRIS') {
                allDOM.cashPaymentSection.style.display = 'none';
                allDOM.changeSection.style.display = 'none';
                qrisSection.classList.remove('hidden');
                validateQrisInput();
            } else {
                allDOM.cashPaymentSection.style.display = 'none';
                allDOM.changeSection.style.display = 'none';
                qrisSection.classList.add('hidden');
                allDOM.confirmPaymentButton.disabled = false;
            }
        }

        function validateQrisInput() {
            const isQrisValid = currentPaymentMethod === 'QRIS' ? qrisInput.value.trim() !== '' : true;
            allDOM.confirmPaymentButton.disabled = !isQrisValid;
        }
        qrisInput.addEventListener('input', validateQrisInput);

        function processPayment() {
            const cartForTx = splitBillState.active ? splitBillState.newCart : cart;
            const subtotal = cartForTx.reduce((sum, item) => sum + (item.finalPrice * item.quantity), 0);
            
            let discountValue = 0;
            if (!splitBillState.active) {
                discountValue = discount.type === 'percentage' ? subtotal * (discount.value / 100) : discount.value;
                discountValue = Math.min(subtotal, discountValue);
            }

            const totalAfterDiscount = subtotal - discountValue;
            const tax = settings.taxEnabled ? totalAfterDiscount * (settings.taxRate / 100) : 0;
            const total = totalAfterDiscount + tax;
            const diterima = (currentPaymentMethod !== 'Tunai') ? total : parseFloat(allDOM.uangDiterimaInput.value);
            
            let customerName = 'Tamu Biasa';
            if(currentCustomerId) {
                const customer = customers.find(c => c.id === currentCustomerId);
                if(customer) customerName = customer.name;
            }

            let qrisCode = null;
            if (currentPaymentMethod === 'QRIS') {
                qrisCode = qrisInput.value.trim();
                if (!qrisCode) {
                    showToast('Kode QRIS harus diisi!', 'error');
                    return;
                }
            }

            const orderNoteText = orderNote.value.trim();

            const transaction = { 
                id: Date.now(), 
                items: JSON.parse(JSON.stringify(cartForTx)), 
                subtotal, 
                discount: discountValue, 
                tax, 
                total, 
                paid: diterima, 
                change: diterima - total, 
                date: new Date().toISOString(), 
                type: currentOrderType, 
                table: currentTable, 
                paymentMethod: currentPaymentMethod, 
                cashierName: settings.cashierName, 
                customerName: customerName, 
                customerId: currentCustomerId,
                qrisCode: qrisCode,
                orderNote: orderNoteText
            };
            
            transactions.push(transaction);
            currentShift.transactions.push(transaction.id);

            if (currentCustomerId) {
                const customer = customers.find(c => c.id === currentCustomerId);
                if (customer && !splitBillState.active) {
                    customer.visits = (customer.visits || 0) + 1;
                    if (customer.visits > 0 && customer.visits % 10 === 0) {
                        setTimeout(() => showToast(`${customer.name} mendapatkan reward! (Kunjungan ke-${customer.visits})`, 'success'), 1000);
                    }
                }
            }
            
            showToast('Transaksi berhasil!', 'success');
            
            if (splitBillState.active) {
                cart = [...splitBillState.originalCart];
                splitBillState = { active: false, originalCart: [], newCart: [] };
                closeModal('split-bill-modal');
                if (cart.length === 0) {
                    if (currentTable) tables.find(t => t.id === currentTable).status = 'needsCleaning';
                    resetOrderState(false);
                } else {
                    renderCart();
                }
            } else {
                if (currentTable) tables.find(t => t.id === currentTable).status = 'needsCleaning';
                resetOrderState(false);
            }

            saveData(); 
            generateReceipt(transaction); 
            showModal('receipt-modal'); 
            closeModal('payment-modal'); 
            
            qrisInput.value = '';
            orderNote.value = '';
        }
        
        function generateReceipt(transaction) {
            const date = new Date(transaction.date);
            const formattedDate = `${date.toLocaleDateString('id-ID')} ${date.toLocaleTimeString('id-ID')}`;
            let itemsHTML = transaction.items.map(item => {
                const levelInfo = item.level ? ` (Lv. ${item.level})` : '';
                const noteInfo = item.note ? `<br><span style='font-size:10px; font-style:italic;'>(${item.note})</span>` : '';
                let spiceCostHTML = '';
                if (item.spiceCost > 0) {
                    spiceCostHTML = `<tr><td style="padding-left:20px;">+ Level Pedas</td><td></td><td style="text-align: right;">${formatRupiah(item.spiceCost * item.quantity)}</td></tr>`;
                }
                return `<tr><td colspan="3" style="padding-top: 4px;">${item.name}${levelInfo}${noteInfo}</td></tr><tr><td style="padding-left:10px;">${item.quantity} x ${formatRupiah(item.price)}</td><td></td><td style="text-align: right;">${formatRupiah(item.price * item.quantity)}</td></tr>${spiceCostHTML}`;
            }).join('');
            const taxHTML = settings.taxEnabled ? `<tr><td>Pajak (${settings.taxRate}%):</td><td style="text-align: right;">${formatRupiah(transaction.tax)}</td></tr>` : '';
            const discountHTML = transaction.discount > 0 ? `<tr><td>Diskon:</td><td style="text-align: right;">- ${formatRupiah(transaction.discount)}</td></tr>` : '';
            
            const logoHTML = settings.storeLogo ? `<div style="text-align: center; margin-bottom: 12px;"><img src="${settings.storeLogo}" alt="Logo" style="max-width: 150px; max-height: 80px; margin: auto;"></div>` : '';
            const cashierHTML = settings.receiptShowCashier ? `<p>Kasir: ${transaction.cashierName}</p>` : '';
            const orderTypeHTML = settings.receiptShowOrderType ? `<p>Tipe: ${transaction.type}${transaction.table ? ` / Meja ${transaction.table}` : ''}</p>` : '';
            const customerHTML = transaction.customerName !== 'Tamu Biasa' ? `<p>Pelanggan: ${transaction.customerName}</p>`: '';
            const qrisHTML = transaction.qrisCode ? `<p>Kode QRIS: ${transaction.qrisCode}</p>` : '';
            const orderNoteHTML = transaction.orderNote ? `<p>Catatan: ${transaction.orderNote}</p>` : '';

            const receiptBase = `<div style="font-family: 'Courier New', monospace; font-size: 12px; color: #000;">
                ${logoHTML}
                <h3 style="text-align: center; font-size: 16px; margin-bottom: 8px;">${settings.storeName}</h3>
                <p style="text-align: center; margin-bottom: 12px; font-size: 10px;">${settings.storeAddress}</p>
                <p>No: ${transaction.id}</p>
                <p>Tanggal: ${formattedDate}</p>
                ${orderTypeHTML}
                ${cashierHTML}
                ${customerHTML}
                ${qrisHTML}
                ${orderNoteHTML}
                <p>Pembayaran: ${transaction.paymentMethod}</p>
                <hr style="border-top: 1px dashed #000; margin: 8px 0;">
                <table style="width: 100%; border-collapse: collapse;"><tbody>${itemsHTML}</tbody></table>
                <hr style="border-top: 1px dashed #000; margin: 8px 0;">
                <table style="width: 100%;">
                    <tr><td>Subtotal:</td><td style="text-align: right;">${formatRupiah(transaction.subtotal)}</td></tr>
                    ${discountHTML}
                    ${taxHTML}
                    <tr><td style="font-weight: bold;">Total:</td><td style="text-align: right; font-weight: bold;">${formatRupiah(transaction.total)}</td></tr>
                    <tr><td>Bayar:</td><td style="text-align: right;">${formatRupiah(transaction.paid)}</td></tr>
                    ${transaction.paymentMethod === 'Tunai' ? `<tr><td>Kembali:</td><td style="text-align: right;">${formatRupiah(transaction.change)}</td></tr>` : ''}
                </table>
                <p style="text-align: center; margin-top: 16px;">${settings.receiptFooter}</p>
            </div>`;

            document.getElementById('receipt-print-area').innerHTML = `<div class="receipt-copy">${receiptBase}</div>`;
        }
        function printReceipt() { window.print(); }
        
        // --- TABLE MANAGEMENT ---
        function showTableModal() { renderTables(); showModal('table-modal'); }
        function renderTables() {
            allDOM.tableGrid.innerHTML = tables.map(table => {
                let buttonClass = 'bg-slate-100 dark:bg-slate-700 hover:bg-sky-100 dark:hover:bg-sky-600 text-slate-800 dark:text-slate-200';
                let action = `selectTable(${table.id})`;
                let title = 'Meja Kosong';
                if (table.status === 'occupied') { 
                    buttonClass = 'bg-amber-400 hover:bg-amber-500 text-white'; 
                    action = `openOrder(${table.id})`;
                    title = 'Meja Terisi, Klik untuk Buka Pesanan';
                }
                if (table.status === 'needsCleaning') { 
                    buttonClass = 'bg-red-500 hover:bg-red-600 text-white'; 
                    action = `cleanTable(${table.id})`;
                    title = 'Meja Perlu Dibersihkan, Klik untuk Konfirmasi';
                }
                if (table.id === currentTable) { 
                    buttonClass = 'bg-sky-600 text-white ring-4 ring-sky-300'; 
                }
                return `<button onclick="${action}" title="${title}" class="p-4 rounded-lg font-bold text-lg transition ${buttonClass}">${table.name}</button>`;
            }).join('');
        }

        function selectTable(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (cart.length > 0 && currentTable !== null && currentTable !== tableId) {
                showToast('Selesaikan atau simpan pesanan saat ini terlebih dahulu!', 'error');
                return;
            }
            if (table.status !== 'available') {
                showToast(`Meja ${tableId} sedang tidak tersedia.`, 'error');
                return;
            }
            currentTable = tableId;
            allDOM.tableNumberDisplay.textContent = table.id;
            allDOM.tableDisplay.classList.remove('hidden');
            closeModal('table-modal');
        }

        function cleanTable(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (table) {
                showConfirm(`Konfirmasi Meja ${tableId}`, 'Apakah Anda yakin meja ini sudah bersih dan siap digunakan?', () => {
                    table.status = 'available';
                    renderTables();
                    saveData();
                });
            }
        }

        // --- HELD ORDERS & SHIFT MANAGEMENT ---
        function holdOrder() {
            if (cart.length === 0) { showToast('Keranjang kosong, tidak ada yang bisa disimpan.', 'error'); return; }
            if (currentTable === null) { showToast('Pilih meja terlebih dahulu untuk menyimpan pesanan.', 'error'); return; }

            const order = {
                id: currentTable,
                cart: [...cart],
                table: currentTable,
                customerId: currentCustomerId,
                customerType: currentCustomerType,
                orderType: currentOrderType,
                createdAt: new Date().toISOString()
            };
            
            const existingOrderIndex = heldOrders.findIndex(o => o.id === currentTable);
            if (existingOrderIndex > -1) {
                heldOrders[existingOrderIndex] = order;
            } else {
                heldOrders.push(order);
            }

            const table = tables.find(t => t.id === currentTable);
            if (table) table.status = 'occupied';
            
            showToast(`Pesanan untuk Meja ${currentTable} disimpan.`, 'success');
            resetOrderState(false);
            updateActiveOrdersBadge();
        }

        function openOrder(tableId) {
            if (cart.length > 0) {
                showToast('Selesaikan atau simpan pesanan saat ini sebelum membuka pesanan lain.', 'error');
                return;
            }
            const orderIndex = heldOrders.findIndex(o => o.id === tableId);
            if (orderIndex === -1) {
                showToast(`Tidak ada pesanan aktif untuk Meja ${tableId}.`, 'error');
                return;
            }
            
            const orderToOpen = heldOrders[orderIndex];
            cart = orderToOpen.cart;
            currentTable = orderToOpen.table;
            setCustomerType(orderToOpen.customerType);
            if (orderToOpen.customerId) {
                selectCustomerForOrder(orderToOpen.customerId);
            }
            setOrderType(orderToOpen.orderType);

            allDOM.tableNumberDisplay.textContent = currentTable;
            allDOM.tableDisplay.classList.remove('hidden');
            
            heldOrders.splice(orderIndex, 1);
            
            renderCart();
            updateActiveOrdersBadge();
            closeModal('active-orders-modal');
            closeModal('table-modal');
            showToast(`Pesanan Meja ${tableId} dibuka.`);
        }

        function showActiveOrdersModal() {
            renderActiveOrders();
            showModal('active-orders-modal');
        }
        function renderActiveOrders() {
            if (heldOrders.length === 0) {
                allDOM.activeOrdersList.innerHTML = `<p class="col-span-full text-center text-slate-400 dark:text-slate-500">Tidak ada pesanan yang disimpan.</p>`;
                return;
            }
            allDOM.activeOrdersList.innerHTML = heldOrders.map(order => {
                const total = order.cart.reduce((sum, item) => sum + (item.finalPrice * item.quantity), 0);
                const customer = customers.find(c => c.id === order.customerId);
                return `<div onclick="openOrder(${order.id})" class="bg-slate-100 dark:bg-slate-900/70 p-4 rounded-lg cursor-pointer hover:bg-sky-100 dark:hover:bg-sky-900/50 transition">
                    <p class="font-bold text-lg">Meja ${order.table}</p>
                    <p class="text-sm text-slate-500">${customer ? customer.name : 'Tamu'}</p>
                    <p class="font-bold mt-2">${formatRupiah(total)}</p>
                </div>`;
            }).join('');
        }

        function updateActiveOrdersBadge() {
            const count = heldOrders.length;
            if (count > 0) {
                allDOM.activeOrdersBadge.textContent = count;
                allDOM.activeOrdersBadge.classList.remove('hidden');
            } else {
                allDOM.activeOrdersBadge.classList.add('hidden');
            }
        }
        
        function startShift() {
            const startCashInput = document.getElementById('start-cash-input');
            const startCash = parseFloat(startCashInput.value) || 0;

            currentShift = {
                active: true,
                startTime: new Date().toISOString(),
                startCash: startCash,
                transactions: []
            };
            saveData();
            allDOM.shiftModal.style.display = 'none';
            allDOM.mainContainer.classList.remove('opacity-20', 'pointer-events-none');
            showToast(`Shift dimulai dengan modal ${formatRupiah(startCash)}`, 'success');
        }

        function showEndOfShiftReport() {
            const shiftTransactions = transactions.filter(tx => currentShift.transactions.includes(tx.id));

            const cashSales = shiftTransactions.filter(tx => tx.paymentMethod === 'Tunai').reduce((sum, tx) => sum + tx.total, 0);
            const nonCashSales = shiftTransactions.filter(tx => tx.paymentMethod !== 'Tunai').reduce((sum, tx) => sum + tx.total, 0);
            const totalDiscount = shiftTransactions.reduce((sum, tx) => sum + tx.discount, 0);
            const grossSales = cashSales + nonCashSales;
            const expectedCash = currentShift.startCash + cashSales;

            document.getElementById('shift-report-store-name').textContent = settings.storeName;
            document.getElementById('shift-report-cashier').textContent = `Kasir: ${settings.cashierName}`;
            document.getElementById('shift-report-time').textContent = `Mulai: ${new Date(currentShift.startTime).toLocaleTimeString('id-ID')} - Sekarang`;

            document.getElementById('shift-report-start-cash').textContent = formatRupiah(currentShift.startCash);
            document.getElementById('shift-report-cash-sales').textContent = formatRupiah(cashSales);
            document.getElementById('shift-report-expected-cash').textContent = formatRupiah(expectedCash);
            document.getElementById('shift-report-noncash-sales').textContent = formatRupiah(nonCashSales);
            document.getElementById('shift-report-total-discount').textContent = `- ${formatRupiah(totalDiscount)}`;
            document.getElementById('shift-report-gross-sales').textContent = formatRupiah(grossSales);
            
            showModal('end-of-shift-report-modal');
        }

        function endShift() {
            showConfirm('Akhiri Shift?', 'Anda akan mengakhiri sesi kerja saat ini. Pastikan semua transaksi sudah selesai.', () => {
                currentShift.active = false;
                saveData();
                location.reload();
            });
        }
        
        // --- SPLIT BILL ---
        function showSplitBillModal() {
            splitBillState.active = true;
            splitBillState.originalCart = JSON.parse(JSON.stringify(cart));
            splitBillState.newCart = [];
            renderSplitBillUI();
            closeModal('payment-modal');
            showModal('split-bill-modal');
        }

        function renderSplitBillUI() {
            const originalContainer = document.querySelector('#split-bill-original-items div');
            const newContainer = document.querySelector('#split-bill-new-bill div');

            originalContainer.innerHTML = splitBillState.originalCart.map(item => renderSplitItem(item, 'original')).join('');
            newContainer.innerHTML = splitBillState.newCart.map(item => renderSplitItem(item, 'new')).join('');

            document.getElementById('split-original-count').textContent = splitBillState.originalCart.reduce((sum, i) => sum + i.quantity, 0);
            document.getElementById('split-new-count').textContent = splitBillState.newCart.reduce((sum, i) => sum + i.quantity, 0);

            const newTotal = calculateTotal(splitBillState.newCart);
            document.getElementById('split-new-total').textContent = formatRupiah(newTotal);
        }

        function renderSplitItem(item, type) {
             const action = type === 'original' ? `moveItemToNewBill(${item.cartId})` : `moveItemToOriginalBill(${item.cartId})`;
            const icon = type === 'original' ? '‚Üí' : '‚Üê';
            return `<div class="flex items-center p-2 bg-white dark:bg-slate-800 rounded-lg">
                <span class="flex-grow">${item.quantity}x ${item.name}</span>
                <span class="font-semibold mr-4">${formatRupiah(item.finalPrice * item.quantity)}</span>
                <button onclick="${action}" class="w-8 h-8 bg-sky-500 text-white rounded-lg font-bold">${icon}</button>
            </div>`;
        }

        function moveItemToNewBill(cartId) { moveItemBetweenBills(cartId, splitBillState.originalCart, splitBillState.newCart); }
        function moveItemToOriginalBill(cartId) { moveItemBetweenBills(cartId, splitBillState.newCart, splitBillState.originalCart); }

        function moveItemBetweenBills(cartId, source, destination) {
            const sourceItemIndex = source.findIndex(i => i.cartId === cartId);
            if (sourceItemIndex === -1) return;

            const itemToMove = source[sourceItemIndex];
            const destItem = destination.find(i => i.id === itemToMove.id && i.level === itemToMove.level && i.note === itemToMove.note);

            if (destItem) {
                destItem.quantity++;
            } else {
                destination.push({ ...itemToMove, quantity: 1 });
            }

            itemToMove.quantity--;
            if (itemToMove.quantity === 0) {
                source.splice(sourceItemIndex, 1);
            }
            renderSplitBillUI();
        }

        function processSplitBillPayment() {
            if (splitBillState.newCart.length === 0) {
                showToast('Pindahkan item ke tagihan baru terlebih dahulu!', 'error');
                return;
            }
            cart = [...splitBillState.newCart];
            showPaymentModal();
        }
        
        function splitBillEvenly() {
            const count = parseInt(document.getElementById('split-evenly-input').value);
            if (!count || count < 2) {
                document.getElementById('split-evenly-result').textContent = 'Masukkan jumlah orang (min 2).';
                return;
            }
            const total = calculateTotal(cart);
            const amountPerPerson = total / count;
            document.getElementById('split-evenly-result').textContent = `${count} orang @ ${formatRupiah(amountPerPerson)}`;
        }
        
        // --- HISTORY & DASHBOARD ---
        function showHistoryModal() { renderHistory(); showModal('history-modal'); }
        function showDashboardModal() { renderDashboard('today'); showModal('dashboard-modal'); }
        function showDiscountModal() { showModal('discount-modal'); }
        function renderHistory() {
            const historyListEl = document.getElementById('history-list');
            if (transactions.length === 0) { historyListEl.innerHTML = '<p class="text-slate-400 dark:text-slate-500 text-center">Belum ada transaksi.</p>'; return; }
            const historyHTML = [...transactions].reverse().map(tx => {
                const date = new Date(tx.date);
                const itemsSummary = tx.items.map(i => `${i.quantity}x ${i.name}`).join(', ');
                const paymentMethodBadge = `<span class="text-xs font-semibold text-white bg-slate-800 dark:bg-slate-600 px-2 py-1 rounded-full ml-2">${tx.paymentMethod}</span>`;
                
                return `<div class="bg-slate-100 dark:bg-slate-900/70 p-4 rounded-xl mb-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold flex items-center">${tx.customerName} <span class="text-slate-400 font-normal mx-2">-</span> ${tx.type}${tx.table ? ` / Meja ${tx.table}` : ''} ${paymentMethodBadge}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${date.toLocaleString('id-ID')} (#${tx.id})</p>
                        </div>
                        <p class="font-bold text-lg text-slate-900 dark:text-slate-200">${formatRupiah(tx.total)}</p>
                    </div>
                    <p class="text-sm mt-2 text-slate-600 dark:text-slate-300">${itemsSummary}</p>
                </div>`;
            }).join('');
            historyListEl.innerHTML = historyHTML;
        }

        function renderDashboard(range, event) {
            document.querySelectorAll('.dashboard-range-btn').forEach(btn => btn.classList.remove('bg-sky-500', 'text-white'));
            if(event) {
                event.target.classList.add('bg-sky-500', 'text-white');
            } else {
                document.querySelector(`.dashboard-range-btn[onclick*="'${range}'"]`).classList.add('bg-sky-500', 'text-white');
            }
            
            const now = new Date();
            let startDate, endDate = new Date(now);
            if (range === 'today') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (range === '7days') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6);
            } else if (range === '30days') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 29);
            } else if (range === 'custom') {
                const startStr = prompt('Tanggal mulai (YYYY-MM-DD):', '2025-01-01');
                const endStr = prompt('Tanggal akhir (YYYY-MM-DD):', '2025-12-31');
                if (!startStr || !endStr) return;
                startDate = new Date(startStr + 'T00:00:00');
                endDate = new Date(endStr + 'T23:59:59');
            }
            startDate.setHours(0,0,0,0);
            endDate.setHours(23,59,59,999);
            
            const cashierFilter = dashboardCashierFilter.value;
            let filteredTx = transactions.filter(tx => {
                const txDate = new Date(tx.date);
                return txDate >= startDate && txDate <= endDate;
            });
            if (cashierFilter !== 'all') {
                filteredTx = filteredTx.filter(tx => tx.cashierName === cashierFilter);
            }

            const dashboardContentEl = document.getElementById('dashboard-content');
            if (filteredTx.length === 0) { dashboardContentEl.innerHTML = '<p class="text-slate-400 dark:text-slate-500 text-center">Tidak ada data penjualan untuk rentang waktu ini.</p>'; return; }
            
            const totalRevenue = filteredTx.reduce((sum, tx) => sum + tx.total, 0);
            const totalTransactions = filteredTx.length;
            const totalHPP = filteredTx.reduce((sum, tx) => {
                return sum + tx.items.reduce((itemSum, item) => itemSum + ((item.hpp || 0) * item.quantity), 0);
            }, 0);
            const estimatedProfit = totalRevenue - totalHPP;
            
            const itemSales = filteredTx.flatMap(tx => tx.items).reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + item.quantity; return acc; }, {});
            const bestSellers = Object.entries(itemSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            const statsHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl text-center shadow-lg shadow-slate-200/50 dark:shadow-black/20"><h4 class="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase">Total Pendapatan</h4><p class="text-3xl font-bold text-sky-600 dark:text-sky-500">${formatRupiah(totalRevenue)}</p></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl text-center shadow-lg shadow-slate-200/50 dark:shadow-black/20"><h4 class="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase">Perkiraan Laba</h4><p class="text-3xl font-bold text-green-600 dark:text-green-500">${formatRupiah(estimatedProfit)}</p></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl text-center shadow-lg shadow-slate-200/50 dark:shadow-black/20"><h4 class="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase">Total Transaksi</h4><p class="text-3xl font-bold text-amber-600 dark:text-amber-500">${totalTransactions}</p></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl text-center shadow-lg shadow-slate-200/50 dark:shadow-black/20"><h4 class="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase">Avg. per Transaksi</h4><p class="text-3xl font-bold text-indigo-600 dark:text-indigo-500">${totalTransactions > 0 ? formatRupiah(totalRevenue / totalTransactions) : 'Rp 0'}</p></div>
            </div>`;

            const bestSellersHTML = bestSellers.map(item => `<li class="flex justify-between items-center bg-white dark:bg-slate-900/70 p-3 rounded-lg mb-2 shadow-sm"><span class="font-semibold">${item[0]}</span><span class="bg-sky-500 text-white text-xs font-bold px-2 py-1 rounded-full">${item[1]}</span></li>`).join('');
            
            const salesByDate = {};
            filteredTx.forEach(tx => {
                const date = new Date(tx.date).toLocaleDateString('en-CA');
                salesByDate[date] = (salesByDate[date] || 0) + tx.total;
            });
            const chartData = Object.keys(salesByDate).sort().map(date => ({x: date, y: salesByDate[date]}));

            const salesByHour = Array(24).fill(0);
            filteredTx.forEach(tx => {
                const hour = new Date(tx.date).getHours();
                salesByHour[hour] += tx.total;
            });

            dashboardContentEl.innerHTML = `${statsHTML}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-black/20"><h4 class="text-xl font-bold mb-4">Grafik Pendapatan Harian</h4><canvas id="salesChart"></canvas></div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg shadow-slate-200/50 dark:shadow-black/20"><h4 class="text-xl font-bold mb-4">Analisis Jam Sibuk</h4><canvas id="hourlySalesChart"></canvas></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div><h4 class="text-xl font-bold mb-4">Produk Terlaris</h4><ul class="space-y-2">${bestSellersHTML}</ul></div>
            </div>`;
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? '#334155' : '#e2e8f0';
            const textColor = isDarkMode ? '#cbd5e1' : '#64748b';
            
            const ctxSales = document.getElementById('salesChart').getContext('2d');
            if(salesChart) salesChart.destroy();
            salesChart = new Chart(ctxSales, { type: 'bar', data: { datasets: [{ label: 'Pendapatan (Rp)', data: chartData, backgroundColor: 'rgba(14, 165, 233, 0.6)', borderColor: 'rgba(14, 165, 233, 1)', borderWidth: 1, borderRadius: 8 }] }, options: { scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { type: 'time', time: { unit: 'day' }, grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });

            const ctxHourly = document.getElementById('hourlySalesChart').getContext('2d');
            if(hourlySalesChart) hourlySalesChart.destroy();
            hourlySalesChart = new Chart(ctxHourly, { type: 'bar', data: { labels: Array.from({length: 24}, (_, i) => `${i}:00`), datasets: [{ label: 'Pendapatan (Rp)', data: salesByHour, backgroundColor: 'rgba(132, 204, 22, 0.6)', borderColor: 'rgba(132, 204, 22, 1)', borderWidth: 1, borderRadius: 8 }] }, options: { scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
        }

        // --- CUSTOMER MANAGEMENT ---
        function setCustomerType(type) {
            currentCustomerType = type;
            document.querySelectorAll('.customer-type-btn').forEach(btn => btn.classList.remove('active-order-type'));
            document.getElementById(`customer-type-${type}`).classList.add('active-order-type');

            if (type === 'member') {
                allDOM.customerSelectionArea.classList.remove('hidden');
            } else {
                allDOM.customerSelectionArea.classList.add('hidden');
                clearSelectedCustomer(); 
            }
        }

        function showCustomerModal() {
            renderCustomerList();
            allDOM.addCustomerView.classList.remove('hidden');
            allDOM.customerDetailsView.classList.add('hidden');
            showModal('customer-modal');
        }

        function renderCustomerList(searchTerm = '') {
            const lowerSearchTerm = searchTerm.toLowerCase();
            const filteredCustomers = customers.filter(c => c.name.toLowerCase().includes(lowerSearchTerm));

            if(filteredCustomers.length === 0) {
                allDOM.customerList.innerHTML = `<p class="text-slate-400 text-center p-4">Belum ada pelanggan.</p>`;
                return;
            }

            allDOM.customerList.innerHTML = filteredCustomers.map(c => `
                <div onclick="viewCustomerDetails(${c.id})" class="p-3 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer">
                    <p class="font-bold">${c.name}</p>
                    <p class="text-sm text-slate-500">${c.phone || 'No. HP tidak ada'}</p>
                </div>
            `).join('');
        }
        
        function addNewCustomer() {
            const nameInput = document.getElementById('new-customer-name');
            const phoneInput = document.getElementById('new-customer-phone');
            const name = nameInput.value.trim();

            if (!name) {
                showToast('Nama pelanggan tidak boleh kosong!', 'error');
                return;
            }

            const newCustomer = {
                id: Date.now(),
                name: name,
                phone: phoneInput.value.trim(),
                visits: 0,
            };

            customers.push(newCustomer);
            saveData();
            showToast('Pelanggan baru ditambahkan!', 'success');
            nameInput.value = '';
            phoneInput.value = '';
            renderCustomerList();
            viewCustomerDetails(newCustomer.id);
        }

        function viewCustomerDetails(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            document.getElementById('details-customer-name').textContent = customer.name;
            document.getElementById('details-customer-phone').textContent = customer.phone || 'No. HP tidak ada';
            document.getElementById('details-customer-visits').textContent = customer.visits || 0;
            
            const nextReward = 10 - ((customer.visits || 0) % 10);
            document.getElementById('details-customer-reward').textContent = `${nextReward} kunjungan lagi`;

            const customerHistory = transactions.filter(tx => tx.customerId === customerId).reverse();
            const historyEl = document.getElementById('details-customer-history');
            if (customerHistory.length > 0) {
                historyEl.innerHTML = customerHistory.map(tx => `
                    <div class="text-sm bg-white dark:bg-slate-800 p-2 rounded-md">
                        <div class="flex justify-between">
                            <span class="font-semibold">${new Date(tx.date).toLocaleDateString('id-ID')}</span>
                            <span class="font-bold">${formatRupiah(tx.total)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                historyEl.innerHTML = `<p class="text-slate-400 text-sm text-center">Belum ada riwayat transaksi.</p>`;
            }

            document.getElementById('select-customer-btn').onclick = () => selectCustomerForOrder(customerId);

            allDOM.addCustomerView.classList.add('hidden');
            allDOM.customerDetailsView.classList.remove('hidden');
        }

        function selectCustomerForOrder(customerId) {
            currentCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                allDOM.customerNameDisplay.textContent = customer.name;
                allDOM.customerNameDisplay.classList.remove('text-slate-500', 'dark:text-slate-400');
                allDOM.clearCustomerBtn.classList.remove('hidden');
            }
            closeModal('customer-modal');
        }
        
        function clearSelectedCustomer() {
            currentCustomerId = null;
            allDOM.customerNameDisplay.textContent = 'Pilih Member...';
            allDOM.customerNameDisplay.classList.add('text-slate-500', 'dark:text-slate-400');
            allDOM.clearCustomerBtn.classList.add('hidden');
        }

        // --- SETTINGS & INVENTORY ---
        function showSettingsModal() {
            document.getElementById('setting-store-name').value = settings.storeName;
            document.getElementById('setting-store-address').value = settings.storeAddress;
            document.getElementById('setting-cashier-name').value = settings.cashierName;
            document.getElementById('setting-tax-rate').value = settings.taxRate;
            document.getElementById('setting-tax-enabled').checked = settings.taxEnabled;
            document.getElementById('setting-receipt-footer').value = settings.receiptFooter;
            document.getElementById('logo-preview').src = settings.storeLogo || 'https://placehold.co/80x80/e2e8f0/94a3b8?text=Logo';
            document.getElementById('setting-receipt-show-cashier').checked = settings.receiptShowCashier;
            document.getElementById('setting-receipt-show-order-type').checked = settings.receiptShowOrderType;
            document.getElementById('setting-receipt-logo').value = '';

            // Isi level pedas
            document.getElementById('setting-spice-1').value = settings.spiceLevelCosts[1] || 0;
            document.getElementById('setting-spice-2').value = settings.spiceLevelCosts[2] || 0;
            document.getElementById('setting-spice-3').value = settings.spiceLevelCosts[3] || 2000;
            document.getElementById('setting-spice-4').value = settings.spiceLevelCosts[4] || 4000;
            document.getElementById('setting-spice-5').value = settings.spiceLevelCosts[5] || 6000;

            // Isi jumlah meja
            document.getElementById('setting-table-count').value = settings.tableCount || 12;

            showModal('settings-modal');
            switchSettingsTab(null, 'umum');
        }
        
        async function saveSettings() {
            settings.storeName = document.getElementById('setting-store-name').value;
            settings.storeAddress = document.getElementById('setting-store-address').value;
            settings.cashierName = document.getElementById('setting-cashier-name').value;
            settings.taxRate = parseFloat(document.getElementById('setting-tax-rate').value) || 10;
            settings.taxEnabled = document.getElementById('setting-tax-enabled').checked;
            settings.receiptFooter = document.getElementById('setting-receipt-footer').value;
            settings.receiptShowCashier = document.getElementById('setting-receipt-show-cashier').checked;
            settings.receiptShowOrderType = document.getElementById('setting-receipt-show-order-type').checked;

            const logoFile = document.getElementById('setting-receipt-logo').files[0];
            if (logoFile) {
                try {
                    const base64Logo = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(logoFile);
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                    });
                    settings.storeLogo = base64Logo;
                } catch (error) {
                    console.error("Error reading logo file:", error);
                    showToast('Gagal memuat logo.', 'error');
                }
            }

            // Simpan level pedas
            settings.spiceLevelCosts = {
                1: parseInt(document.getElementById('setting-spice-1').value) || 0,
                2: parseInt(document.getElementById('setting-spice-2').value) || 0,
                3: parseInt(document.getElementById('setting-spice-3').value) || 2000,
                4: parseInt(document.getElementById('setting-spice-4').value) || 4000,
                5: parseInt(document.getElementById('setting-spice-5').value) || 6000
            };

            // Simpan jumlah meja (akan diterapkan nanti)
            const newTableCount = parseInt(document.getElementById('setting-table-count').value) || 12;
            if (newTableCount !== settings.tableCount) {
                settings.tableCount = newTableCount;
                updateTableCount();
            }
            
            allDOM.headerStoreName.textContent = settings.storeName;
            allDOM.taxRateDisplay.textContent = settings.taxRate;
            updateSummary();
            saveData();
            showToast('Pengaturan disimpan!');
            closeModal('settings-modal');
        }

        function removeLogo() {
            settings.storeLogo = null;
            document.getElementById('logo-preview').src = 'https://placehold.co/80x80/e2e8f0/94a3b8?text=Logo';
            document.getElementById('setting-receipt-logo').value = '';
            showToast('Logo dihapus.');
        }

        function switchSettingsTab(event, tabName) {
            document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`settings-tab-${tabName}`).classList.remove('hidden');
            const button = event ? event.target : document.querySelector(`.settings-tab[onclick*="'${tabName}'"]`);
            if (button) button.classList.add('active');
        }

        function updateTableCount() {
            const newCount = settings.tableCount;
            // Update array tables
            if (newCount > tables.length) {
                // Tambah meja
                for (let i = tables.length + 1; i <= newCount; i++) {
                    tables.push({ id: i, name: `M${i}`, status: 'available' });
                }
            } else if (newCount < tables.length) {
                // Kurangi meja, pastikan tidak ada meja yang sedang digunakan
                const usedTables = tables.slice(newCount).some(t => t.status !== 'available' && heldOrders.some(o => o.table === t.id));
                if (usedTables) {
                    showToast('Tidak bisa mengurangi meja karena ada meja yang masih digunakan!', 'error');
                    return;
                }
                tables = tables.slice(0, newCount);
            }
            renderTables(); // perbarui tampilan jika modal sedang terbuka
            saveData();
        }

        function exportData() {
            const dataStr = JSON.stringify({ transactions, menuItems, settings, customers, heldOrders, currentShift, shiftHistory }, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `mieayamabdillah_backup_${new Date().toISOString().slice(0,10)}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            showToast('Data berhasil diekspor!');
        }
        function confirmResetData() {
            showConfirm('Reset Seluruh Data?', 'Semua transaksi, pelanggan, dan stok akan dihapus. Tindakan ini tidak dapat diurungkan!', resetData);
        }
        function resetData() {
            localStorage.removeItem('mieayamAppData');
            showToast('Data aplikasi berhasil direset!', 'error');
            location.reload(); 
        }

        // --- INVENTORY ---
        function showInventoryModal() { renderInventory(); showModal('inventory-modal'); }
        function renderInventory() {
            allDOM.inventoryList.innerHTML = menuItems.map(item => 
                `<div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-center p-3 rounded-lg odd:bg-slate-50 dark:odd:bg-slate-900/50">
                    <div class="md:col-span-2 flex items-center">
                        <img src="${item.image}" class="w-10 h-10 rounded-md object-cover mr-4">
                        <span class="font-semibold">${item.name}</span>
                    </div>
                    <div class="flex items-center justify-start md:justify-center space-x-2">
                        <label class="text-sm font-semibold text-slate-500">Stok:</label>
                        <input type="number" id="stock-update-${item.id}" class="w-20 bg-slate-100 dark:bg-slate-700 rounded-md p-2 text-center" value="${item.stock}">
                    </div>
                    <div class="flex items-center justify-start md:justify-center space-x-2">
                        <label class="text-sm font-semibold text-slate-500">HPP:</label>
                        <input type="number" id="hpp-update-${item.id}" class="w-24 bg-slate-100 dark:bg-slate-700 rounded-md p-2 text-center" value="${item.hpp || 0}">
                    </div>
                    <div class="flex items-center justify-end space-x-2">
                        <button onclick="updateItemDetails(${item.id})" class="bg-sky-500 text-white font-semibold px-3 py-2 rounded-lg text-sm">Simpan</button>
                        <button onclick="openEditMenuModal(${item.id})" class="bg-amber-500 text-white font-semibold px-3 py-2 rounded-lg text-sm">Edit</button>
                    </div>
                </div>`
            ).join('');
        }
        
        function updateItemDetails(itemId) {
            const stockInput = document.getElementById(`stock-update-${itemId}`);
            const hppInput = document.getElementById(`hpp-update-${itemId}`);
            const newStock = parseInt(stockInput.value) || 0;
            const newHpp = parseInt(hppInput.value) || 0;
            
            const item = menuItems.find(i => i.id === itemId);
            if (item) {
                item.stock = newStock < 0 ? 0 : newStock;
                item.hpp = newHpp < 0 ? 0 : newHpp;
                showToast(`Detail ${item.name} diperbarui!`, 'success');
                saveData();
                renderMenu();
                renderInventory();
            }
        }

        // --- EDIT MENU ---
        let currentEditItemId = null;

        function openEditMenuModal(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            currentEditItemId = itemId;
            document.getElementById('edit-menu-id').value = item.id;
            document.getElementById('edit-menu-name').value = item.name;
            document.getElementById('edit-menu-price').value = item.price;
            document.getElementById('edit-menu-category').value = item.category;
            document.getElementById('edit-menu-stock').value = item.stock;
            document.getElementById('edit-menu-hpp').value = item.hpp || 0;
            document.getElementById('edit-menu-barcode').value = item.barcode || '';
            document.getElementById('edit-menu-image-preview').src = item.image;
            showModal('edit-menu-modal');
        }

        async function saveMenuEdit() {
            const id = parseInt(document.getElementById('edit-menu-id').value);
            const name = document.getElementById('edit-menu-name').value.trim();
            const price = parseInt(document.getElementById('edit-menu-price').value);
            const category = document.getElementById('edit-menu-category').value;
            const stock = parseInt(document.getElementById('edit-menu-stock').value);
            const hpp = parseInt(document.getElementById('edit-menu-hpp').value) || 0;
            const barcode = document.getElementById('edit-menu-barcode').value.trim();
            const imageFile = document.getElementById('edit-menu-image').files[0];

            if (!name || isNaN(price) || price < 0 || isNaN(stock) || stock < 0) {
                showToast('Isi data dengan benar!', 'error');
                return;
            }

            const itemIndex = menuItems.findIndex(i => i.id === id);
            if (itemIndex === -1) return;

            let imageBase64 = menuItems[itemIndex].image;
            if (imageFile) {
                try {
                    imageBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(imageFile);
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                    });
                } catch (error) {
                    console.error('Gagal membaca gambar:', error);
                    showToast('Gagal memuat gambar', 'error');
                    return;
                }
            }

            menuItems[itemIndex] = {
                ...menuItems[itemIndex],
                name,
                price,
                category,
                stock,
                hpp,
                barcode,
                image: imageBase64
            };

            saveData();
            renderMenu(allDOM.searchBar.value);
            renderInventory();
            closeModal('edit-menu-modal');
            showToast('Menu berhasil diperbarui!', 'success');
        }

        // --- SHIFT MANAGEMENT ---
        function showClockInModal() {
            document.getElementById('clockin-cashier').value = settings.cashierName;
            document.getElementById('clockin-startcash').value = 0;
            showModal('clockin-modal');
        }
        function clockIn() {
            const cashier = document.getElementById('clockin-cashier').value;
            const startCash = parseFloat(document.getElementById('clockin-startcash').value) || 0;
            currentShift = {
                active: true,
                startTime: new Date().toISOString(),
                startCash: startCash,
                cashier: cashier,
                transactions: []
            };
            saveData();
            closeModal('clockin-modal');
            showToast(`Shift dimulai oleh ${cashier} dengan modal ${formatRupiah(startCash)}`, 'success');
            document.getElementById('shift-modal').style.display = 'none';
            document.getElementById('main-container').classList.remove('opacity-20', 'pointer-events-none');
        }

        function showClockOutModal() {
            if (!currentShift.active) {
                showToast('Tidak ada shift yang aktif', 'error');
                return;
            }
            const shiftTx = transactions.filter(tx => currentShift.transactions.includes(tx.id) && tx.paymentMethod === 'Tunai');
            const cashSales = shiftTx.reduce((sum, tx) => sum + tx.total, 0);
            const expectedCash = currentShift.startCash + cashSales;
            document.getElementById('summary-startcash').textContent = formatRupiah(currentShift.startCash);
            document.getElementById('summary-cashsales').textContent = formatRupiah(cashSales);
            document.getElementById('summary-totalcash').textContent = formatRupiah(expectedCash);
            showModal('clockout-modal');
        }
        function clockOut() {
            const shiftTx = transactions.filter(tx => currentShift.transactions.includes(tx.id));
            const cashSales = shiftTx.filter(tx => tx.paymentMethod === 'Tunai').reduce((sum, tx) => sum + tx.total, 0);
            const totalCash = currentShift.startCash + cashSales;
            shiftHistory.push({
                id: Date.now(),
                cashier: currentShift.cashier,
                startTime: currentShift.startTime,
                endTime: new Date().toISOString(),
                startCash: currentShift.startCash,
                cashSales: cashSales,
                totalCash: totalCash,
                transactions: currentShift.transactions
            });
            currentShift.active = false;
            saveData();
            closeModal('clockout-modal');
            showToast('Shift berakhir. Laporan tersimpan.', 'success');
            showShiftReport(shiftHistory[shiftHistory.length-1]);
        }
        function showShiftReport(shift) {
            const content = document.getElementById('shift-report-content');
            const start = new Date(shift.startTime).toLocaleString('id-ID');
            const end = new Date(shift.endTime).toLocaleString('id-ID');
            content.innerHTML = `
                <div class="border-b pb-2"><strong>Kasir:</strong> ${shift.cashier}</div>
                <div class="border-b pb-2"><strong>Mulai:</strong> ${start}</div>
                <div class="border-b pb-2"><strong>Selesai:</strong> ${end}</div>
                <div class="border-b pb-2"><strong>Modal Awal:</strong> ${formatRupiah(shift.startCash)}</div>
                <div class="border-b pb-2"><strong>Penjualan Tunai:</strong> ${formatRupiah(shift.cashSales)}</div>
                <div class="border-b pb-2 font-bold"><strong>Total Tunai di Laci:</strong> ${formatRupiah(shift.totalCash)}</div>
                <div><strong>Jumlah Transaksi:</strong> ${shift.transactions.length}</div>
            `;
            document.getElementById('shift-report-detail').textContent = `Shift #${shift.id}`;
            showModal('shift-report-modal');
        }
        function renderShiftHistory() {
            const list = document.getElementById('shift-history-list');
            if (shiftHistory.length === 0) {
                list.innerHTML = '<p class="text-slate-400">Belum ada shift</p>';
                return;
            }
            list.innerHTML = shiftHistory.slice().reverse().map(s => `
                <div class="flex justify-between items-center p-2 bg-slate-100 dark:bg-slate-900 rounded cursor-pointer hover:bg-sky-100" onclick='showShiftReport(${JSON.stringify(s).replace(/'/g, "\\'")})'>
                    <span>${new Date(s.startTime).toLocaleDateString()} - ${s.cashier}</span>
                    <span class="font-bold">${formatRupiah(s.cashSales)}</span>
                </div>
            `).join('');
        }

        // --- EKSPOR CSV ---
        function exportToCSV() {
            if (transactions.length === 0) {
                showToast('Tidak ada data untuk diekspor', 'error');
                return;
            }
            let csv = "ID,Tanggal,Kasir,Pelanggan,Total,Metode,Item\n";
            transactions.forEach(tx => {
                const items = tx.items.map(i => `${i.quantity}x ${i.name}`).join('; ');
                csv += `${tx.id},${new Date(tx.date).toLocaleString()},${tx.cashierName},${tx.customerName},${tx.total},${tx.paymentMethod},"${items}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transaksi_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Data diekspor sebagai CSV', 'success');
        }

        // --- EOD REPORT ---
        function showEndOfDayReport() {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const todaysTransactions = transactions.filter(tx => new Date(tx.date) >= startOfToday);
            
            const totalRevenue = todaysTransactions.reduce((sum, tx) => sum + tx.total, 0);
            const paymentMethods = todaysTransactions.reduce((acc, tx) => {
                acc[tx.paymentMethod] = (acc[tx.paymentMethod] || 0) + tx.total;
                return acc;
            }, {});

            document.getElementById('eod-store-name').textContent = settings.storeName;
            document.getElementById('eod-date').textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('eod-cashier-name').textContent = settings.cashierName;
            document.getElementById('eod-total-revenue').textContent = formatRupiah(totalRevenue);
            document.getElementById('eod-total-transactions').textContent = todaysTransactions.length;
            
            const paymentMethodsEl = document.getElementById('eod-payment-methods');
            paymentMethodsEl.innerHTML = '';
            Object.keys(paymentMethods).forEach(method => {
                paymentMethodsEl.innerHTML += `<div class="flex justify-between border-b pb-1"><span class="text-slate-600">${method}:</span><span class="font-semibold">${formatRupiah(paymentMethods[method])}</span></div>`;
            });
            
            showModal('eod-report-modal');
        }
        function printEndOfDayReport() { window.print(); }

        // --- THEME ---
        function applyTheme() {
            if (settings.darkMode) {
                document.documentElement.classList.add('dark');
                allDOM.sunIcon.classList.add('hidden');
                allDOM.moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                allDOM.sunIcon.classList.remove('hidden');
                allDOM.moonIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            settings.darkMode = !settings.darkMode;
            applyTheme();
            saveData();
            if (!allDOM.dashboardModal.classList.contains('hidden')) {
                 const activeRange = document.querySelector('.dashboard-range-btn.bg-sky-500')?.onclick.toString().match(/'(.*?)'/)[1] || 'today';
                 renderDashboard(activeRange);
            }
        }

        // --- DATA PERSISTENCE ---
        function saveData() {
            localStorage.setItem('mieayamAppData', JSON.stringify({ menuItems, transactions, tables, settings, customers, heldOrders, currentShift, shiftHistory }));
        }
        function loadData() {
            const savedData = localStorage.getItem('mieayamAppData');
            if (savedData) {
                const appData = JSON.parse(savedData);
                transactions = appData.transactions || [];
                tables = appData.tables || tables;
                customers = appData.customers || [];
                heldOrders = appData.heldOrders || [];
                currentShift = appData.currentShift || { active: false, startTime: null, startCash: 0, transactions: [] };
                shiftHistory = appData.shiftHistory || [];
                settings = { ...settings, ...appData.settings };
                
                const savedMenuItems = appData.menuItems || [];
                const updatedMenuItems = initialMenuItems.map(initialItem => {
                    const savedItem = savedMenuItems.find(saved => saved.id === initialItem.id);
                    if (savedItem) {
                        return { ...initialItem, stock: savedItem.stock, hpp: savedItem.hpp !== undefined ? savedItem.hpp : initialItem.hpp, barcode: savedItem.barcode || initialItem.barcode };
                    }
                    return initialItem;
                });
                menuItems = updatedMenuItems;
            } else {
                menuItems = JSON.parse(JSON.stringify(initialMenuItems));
            }
        }

        // --- FILTER MENU ---
        function filterMenu(category) {
            currentFilter = category;
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active-tab'));
            const activeTab = Array.from(document.querySelectorAll('.category-tab')).find(tab => tab.textContent.toLowerCase().includes(category));
            if(activeTab) activeTab.classList.add('active-tab');
            renderMenu(allDOM.searchBar.value);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            if (!currentShift.active) {
                allDOM.shiftModal.style.display = 'flex';
                allDOM.mainContainer.classList.add('opacity-20', 'pointer-events-none');
            } else {
                allDOM.shiftModal.style.display = 'none';
                allDOM.mainContainer.classList.remove('opacity-20', 'pointer-events-none');
            }
            
            applyTheme();
            allDOM.headerStoreName.textContent = settings.storeName;
            allDOM.taxRateDisplay.textContent = settings.taxRate;
            
            allDOM.searchBar.addEventListener('input', (e) => {
                renderMenu(e.target.value);
                allDOM.searchClearBtn.classList.toggle('hidden', e.target.value === '');
            });
            allDOM.searchClearBtn.addEventListener('click', () => {
                allDOM.searchBar.value = '';
                allDOM.searchClearBtn.classList.add('hidden');
                renderMenu();
            });
            allDOM.darkModeToggle.addEventListener('click', toggleTheme);
            allDOM.customerSearchInput.addEventListener('input', (e) => renderCustomerList(e.target.value));

            setTimeout(() => {
                const uniqueCashiers = [...new Set(transactions.map(tx => tx.cashierName))];
                uniqueCashiers.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dashboardCashierFilter.appendChild(option);
                });
                dashboardCashierFilter.addEventListener('change', () => renderDashboard('today'));
            }, 500);

            renderMenu(); 
            renderCart(); 
            filterMenu('semua'); 
            setOrderType('Dine-In');
            setCustomerType('guest');
            updateSummary();
            updateActiveOrdersBadge();
            renderShiftHistory();
        });
    </script>
</body>
</html>
